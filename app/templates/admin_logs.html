{% extends "base.html" %}

{% block title %}Logs d'Activité - Admin{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-file-alt text-red-600 mr-3"></i>
                    Logs d'Activité
                </h1>
                <p class="text-gray-600">Journal des activités système et utilisateurs</p>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                    <i class="fas fa-home mr-2"></i>
                    Accueil
                </a>
                <a href="{{ url_for('admin.stats') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Statistiques
                </a>
                <button id="clear-logs-btn" class="btn btn-danger">
                    <i class="fas fa-trash-alt mr-2"></i>
                    Effacer Logs
                </button>
                <a href="{{ url_for('admin.logout') }}" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Déconnexion
                </a>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-filter mr-1"></i>Niveau
                </label>
                <select id="filter-level" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tous</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="DEBUG">DEBUG</option>
                </select>
            </div>
            
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user mr-1"></i>Utilisateur
                </label>
                <input type="text" id="filter-user" placeholder="Nom d'utilisateur..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>Recherche
                </label>
                <input type="text" id="filter-search" placeholder="Rechercher dans les messages..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex items-end">
                <button id="apply-filters" class="btn btn-primary">
                    <i class="fas fa-check mr-2"></i>Filtrer
                </button>
            </div>
            
            <div class="flex items-end">
                <button id="reset-filters" class="btn btn-secondary">
                    <i class="fas fa-redo mr-2"></i>Réinitialiser
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card bg-blue-50 border-blue-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Total Logs</p>
                    <p class="text-2xl font-bold text-blue-600">{{ logs|length }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-list text-white text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="card bg-green-50 border-green-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">INFO</p>
                    <p class="text-2xl font-bold text-green-600" id="count-info">0</p>
                </div>
                <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-info-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="card bg-yellow-50 border-yellow-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">WARNING</p>
                    <p class="text-2xl font-bold text-yellow-600" id="count-warning">0</p>
                </div>
                <div class="w-12 h-12 bg-yellow-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="card bg-red-50 border-red-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">ERROR</p>
                    <p class="text-2xl font-bold text-red-600" id="count-error">0</p>
                </div>
                <div class="w-12 h-12 bg-red-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="card">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="logs-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Horodatage
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Niveau
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Utilisateur
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            IP
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Message
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for log in logs %}
                    <tr class="hover:bg-gray-50 transition-colors log-row" data-level="{{ log.level }}" data-user="{{ log.user }}" data-message="{{ log.message }}">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono">
                            {{ log.timestamp }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            {% if log.level == 'ERROR' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                <i class="fas fa-times-circle mr-1"></i>ERROR
                            </span>
                            {% elif log.level == 'WARNING' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>WARNING
                            </span>
                            {% elif log.level == 'INFO' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                <i class="fas fa-info-circle mr-1"></i>INFO
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                {{ log.level }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            <i class="fas fa-user text-gray-400 mr-1"></i>
                            {{ log.user or 'anonymous' }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-mono">
                            {{ log.ip or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {{ log.message }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not logs %}
            <div class="text-center py-12">
                <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500">Aucun log disponible</p>
            </div>
            {% endif %}
            
            <!-- Pagination -->
            <div id="pagination" class="mt-6 flex justify-center gap-2"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Compter les logs par niveau
    function countLogs() {
        const rows = document.querySelectorAll('.log-row');
        const counts = { INFO: 0, WARNING: 0, ERROR: 0, DEBUG: 0 };
        
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const level = row.dataset.level;
                if (counts.hasOwnProperty(level)) {
                    counts[level]++;
                }
            }
        });
        
        document.getElementById('count-info').textContent = counts.INFO;
        document.getElementById('count-warning').textContent = counts.WARNING;
        document.getElementById('count-error').textContent = counts.ERROR;
    }
    
    // Filtrer les logs
    function filterLogs() {
        const levelFilter = document.getElementById('filter-level').value.toLowerCase();
        const userFilter = document.getElementById('filter-user').value.toLowerCase();
        const searchFilter = document.getElementById('filter-search').value.toLowerCase();
        
        allRows.forEach(row => {
            const level = row.dataset.level.toLowerCase();
            const user = row.dataset.user.toLowerCase();
            const message = row.dataset.message.toLowerCase();
            
            let show = true;
            
            if (levelFilter && level !== levelFilter) {
                show = false;
            }
            
            if (userFilter && !user.includes(userFilter)) {
                show = false;
            }
            
            if (searchFilter && !message.includes(searchFilter)) {
                show = false;
            }
            
            row.dataset.filtered = show ? 'true' : 'false';
        });
        
        currentPage = 1;
        paginateLogs();
        countLogs();
    }
    
    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', filterLogs);
    
    document.getElementById('reset-filters').addEventListener('click', () => {
        document.getElementById('filter-level').value = '';
        document.getElementById('filter-user').value = '';
        document.getElementById('filter-search').value = '';
        filterLogs();
    });
    
    // Filtrer en temps réel sur Enter
    document.getElementById('filter-user').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') filterLogs();
    });
    
    document.getElementById('filter-search').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') filterLogs();
    });
    
    // Effacer les logs
    document.getElementById('clear-logs-btn').addEventListener('click', async () => {
        if (!confirm('Êtes-vous sûr de vouloir effacer tous les logs d\'activité ?\n\nCette action est irréversible.')) {
            return;
        }
        
        try {
            const response = await fetch('{{ url_for("admin.clear_logs") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                NotificationManager.success(data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                NotificationManager.error(data.error || 'Erreur lors de l\'effacement des logs');
            }
        } catch (error) {
            console.error('Erreur:', error);
            NotificationManager.error('Erreur lors de la communication avec le serveur');
        }
    });
    
    // Pagination
    const logsPerPage = 50;
    let currentPage = 1;
    let allRows = Array.from(document.querySelectorAll('.log-row'));
    allRows.forEach(row => row.dataset.filtered = 'true');
    
    function paginateLogs() {
        const visibleRows = allRows.filter(row => row.dataset.filtered === 'true');
        const totalPages = Math.ceil(visibleRows.length / logsPerPage);
        const start = (currentPage - 1) * logsPerPage;
        const end = start + logsPerPage;
        
        // Masquer toutes les lignes
        allRows.forEach(row => row.style.display = 'none');
        
        // Afficher les lignes de la page courante
        visibleRows.slice(start, end).forEach(row => row.style.display = '');
        
        // Mettre à jour la pagination
        renderPagination(totalPages, visibleRows.length);
    }
    
    function renderPagination(totalPages, totalLogs) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Bouton précédent
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.className = `px-3 py-2 rounded ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}`;
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                paginateLogs();
            }
        };
        pagination.appendChild(prevBtn);
        
        // Pages
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.textContent = '1';
            firstBtn.className = 'px-4 py-2 rounded bg-white text-gray-700 hover:bg-gray-100';
            firstBtn.onclick = () => {
                currentPage = 1;
                paginateLogs();
            };
            pagination.appendChild(firstBtn);
            
            if (startPage > 2) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.className = 'px-2 text-gray-500';
                pagination.appendChild(dots);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = `px-4 py-2 rounded ${i === currentPage ? 'bg-orange-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`;
            pageBtn.onclick = () => {
                currentPage = i;
                paginateLogs();
            };
            pagination.appendChild(pageBtn);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.className = 'px-2 text-gray-500';
                pagination.appendChild(dots);
            }
            
            const lastBtn = document.createElement('button');
            lastBtn.textContent = totalPages;
            lastBtn.className = 'px-4 py-2 rounded bg-white text-gray-700 hover:bg-gray-100';
            lastBtn.onclick = () => {
                currentPage = totalPages;
                paginateLogs();
            };
            pagination.appendChild(lastBtn);
        }
        
        // Bouton suivant
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.className = `px-3 py-2 rounded ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}`;
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                paginateLogs();
            }
        };
        pagination.appendChild(nextBtn);
        
        // Info
        const info = document.createElement('span');
        info.textContent = `Page ${currentPage} sur ${totalPages} (${totalLogs} logs)`;
        info.className = 'ml-4 text-sm text-gray-600';
        pagination.appendChild(info);
    }
    
    // Initialiser
    paginateLogs();
    countLogs();
</script>
{% endblock %}
