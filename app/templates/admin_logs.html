{% extends "base.html" %}

{% block title %}Logs d'Activité - Admin{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-file-alt text-red-600 mr-3"></i>
                    Logs d'Activité
                </h1>
                <p class="text-gray-600">Journal des activités système et utilisateurs</p>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                    <i class="fas fa-home mr-2"></i>
                    Accueil
                </a>
                <a href="{{ url_for('admin.stats') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Statistiques
                </a>
                <button id="clear-logs-btn" class="btn btn-danger">
                    <i class="fas fa-trash-alt mr-2"></i>
                    Effacer Logs
                </button>
                <a href="{{ url_for('admin.logout') }}" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Déconnexion
                </a>
            </div>
        </div>
    </div>

    <!-- Filters Form -->
    <div class="card mb-6">
        <form action="{{ url_for('admin.logs') }}" method="GET" class="flex flex-wrap gap-4 items-end">
            <!-- Persist page size -->
            <input type="hidden" name="per_page" value="{{ per_page }}">

            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-filter mr-1"></i>Niveau
                </label>
                <select name="level" class="form-select w-full">
                    <option value="">Tous</option>
                    <option value="INFO" {% if current_filters.level=='INFO' %}selected{% endif %}>INFO</option>
                    <option value="WARNING" {% if current_filters.level=='WARNING' %}selected{% endif %}>WARNING
                    </option>
                    <option value="ERROR" {% if current_filters.level=='ERROR' %}selected{% endif %}>ERROR</option>
                    <option value="DEBUG" {% if current_filters.level=='DEBUG' %}selected{% endif %}>DEBUG</option>
                </select>
            </div>

            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user mr-1"></i>Utilisateur
                </label>
                <input type="text" name="user" value="{{ current_filters.user }}" placeholder="Nom d'utilisateur..."
                    class="form-input w-full">
            </div>

            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>Recherche
                </label>
                <input type="text" name="search" value="{{ current_filters.search }}"
                    placeholder="Rechercher message..." class="form-input w-full">
            </div>

            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter mr-2"></i>Filtrer
                </button>
                <a href="{{ url_for('admin.logs') }}" class="btn btn-secondary">
                    <i class="fas fa-redo mr-2"></i>Reset
                </a>
            </div>
        </form>
    </div>

    <!-- Logs Table -->
    <div class="card">
        <div class="mb-4 flex justify-between items-center text-sm text-gray-600">
            <span>Total: <strong>{{ total_logs }}</strong> logs trouvés</span>
            <span>Page <strong>{{ page }}</strong> sur <strong>{{ total_pages }}</strong></span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">
                            Horodatage</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                            Niveau</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                            Utilisateur</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                            IP</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Message</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for log in logs %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono text-xs">
                            {{ log.timestamp }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            {% if log.level == 'ERROR' %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fas fa-times-circle mr-1"></i>ERROR
                            </span>
                            {% elif log.level == 'WARNING' %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>WARN
                            </span>
                            {% elif log.level == 'INFO' %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i>INFO
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {{ log.level }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ log.user or 'anonymous' }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-mono text-xs">
                            {{ log.ip or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900 break-words">
                            {{ log.message }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3 block text-gray-300"></i>
                            Aucun log trouvé pour ces critères
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <div class="mt-6 flex justify-center gap-2">
            <!-- Prev -->
            <a href="{{ url_for('admin.logs', page=page-1, level=current_filters.level, user=current_filters.user, search=current_filters.search) }}"
                class="btn btn-white {% if page == 1 %}opacity-50 pointer-events-none{% endif %}">
                <i class="fas fa-chevron-left"></i>
            </a>

            <!-- First Page -->
            {% if page > 3 %}
            <a href="{{ url_for('admin.logs', page=1, level=current_filters.level, user=current_filters.user, search=current_filters.search) }}"
                class="btn btn-white">1</a>
            <span class="px-2 py-2 text-gray-500">...</span>
            {% endif %}

            <!-- Nearby Pages -->
            {% for p in range(page-2, page+3) %}
            {% if p > 0 and p <= total_pages %} <a
                href="{{ url_for('admin.logs', page=p, level=current_filters.level, user=current_filters.user, search=current_filters.search) }}"
                class="btn {% if p == page %}btn-primary{% else %}btn-white{% endif %}">
                {{ p }}
                </a>
                {% endif %}
                {% endfor %}

                <!-- Last Page -->
                {% if page < total_pages - 2 %} <span class="px-2 py-2 text-gray-500">...</span>
                    <a href="{{ url_for('admin.logs', page=total_pages, level=current_filters.level, user=current_filters.user, search=current_filters.search) }}"
                        class="btn btn-white">{{ total_pages }}</a>
                    {% endif %}

                    <!-- Next -->
                    <a href="{{ url_for('admin.logs', page=page+1, level=current_filters.level, user=current_filters.user, search=current_filters.search) }}"
                        class="btn btn-white {% if page == total_pages %}opacity-50 pointer-events-none{% endif %}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Effacer les logs
    document.getElementById('clear-logs-btn').addEventListener('click', async () => {
        if (!confirm('Êtes-vous sûr de vouloir effacer tous les logs d\'activité ?\n\nCette action est irréversible.')) {
            return;
        }

        try {
            const response = await fetch('{{ url_for("admin.clear_logs") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                NotificationManager.success(data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                NotificationManager.error(data.error || 'Erreur');
            }
        } catch (error) {
            console.error('Erreur:', error);
            NotificationManager.error('Erreur connexion serveur');
        }
    });
</script>
{% endblock %}