{% extends "layout.html" %}

{% block title %}Calculateur - DHIS2 Data Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
<style>
    /* Step Indicator */
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-2xl);
        position: relative;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }

    .step-circle {
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 50%;
        background: var(--gray-200);
        color: var(--gray-500);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
        margin: 0 auto var(--spacing-sm);
        transition: all 0.3s ease;
        border: 3px solid var(--gray-300);
    }

    .step.active .step-circle {
        background: var(--primary-600);
        color: white;
        border-color: var(--primary-700);
        box-shadow: var(--shadow-lg);
    }

    .step.completed .step-circle {
        background: var(--success-600);
        color: white;
        border-color: var(--success-700);
    }

    .step-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-600);
    }

    .step.active .step-label {
        color: var(--primary-600);
    }

    .step.completed .step-label {
        color: var(--success-600);
    }

    /* Dropzone */
    .calc-dropzone {
        border: 3px dashed var(--gray-300);
        border-radius: var(--radius-xl);
        background: white;
        padding: var(--spacing-2xl);
        transition: all 0.3s ease;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .calc-dropzone:hover {
        border-color: var(--primary-600);
        background: var(--primary-50);
        transform: translateY(-2px);
    }

    /* Stats Grid */
    .stat-card {
        background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        color: white;
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        position: relative;
        overflow: hidden;
    }

    .stat-card:nth-child(2) {
        background: linear-gradient(135deg, var(--success-600), var(--success-700));
    }

    .stat-card:nth-child(3) {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .stat-card:nth-child(4) {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
    }

    /* Button Sizes */
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }

    /* Mode Selection */
    .mode-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .mode-card:hover {
        transform: translateY(-4px);
    }

    .mode-card input:checked+.mode-card-inner {
        border-color: var(--primary-600);
        background: var(--primary-50);
        box-shadow: var(--shadow-lg);
    }

    .mode-card-inner {
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        background: white;
        position: relative;
    }

    .mode-check {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: var(--primary-600);
        opacity: 0;
        transform: scale(0.5);
        transition: all 0.3s ease;
    }

    .mode-card input:checked+.mode-card-inner .mode-check {
        opacity: 1;
        transform: scale(1);
    }

    /* Data Type Selection */
    .data-type-card {
        transition: all 0.3s ease;
        position: relative;
    }

    input[name="data-type"]:checked+.data-type-card {
        border-color: var(--primary-600);
        background-color: var(--primary-50);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    input[name="data-type"][value="pivot"]:checked+.data-type-card {
        border-color: #9333ea;
        background-color: #faf5ff;
    }

    .data-type-card::after {
        content: '';
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        background: white;
        transition: all 0.3s ease;
    }

    input[name="data-type"]:checked+.data-type-card::after {
        content: '✓';
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-600);
        border-color: var(--primary-600);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
    }

    input[name="data-type"][value="pivot"]:checked+.data-type-card::after {
        background: #9333ea;
        border-color: #9333ea;
    }

    /* Mapping Interface */
    .mapping-row {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-sm);
        transition: all 0.2s ease;
    }

    .mapping-row:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-sm);
    }

    .mapping-label {
        flex: 1;
        font-weight: 500;
        color: var(--gray-700);
        display: flex;
        align-items: center;
    }

    .mapping-arrow {
        color: var(--gray-400);
    }

    .mapping-select {
        flex: 1;
    }

    .json-preview {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        font-family: monospace;
        max-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-6 py-12 fade-in">

    <!-- Header -->
    <div class="mb-12 text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">
            Calculateur Automatique
        </h1>
        <p class="text-lg text-gray-600">
            Transformez vos fichiers Excel en données importables dans DHIS2
        </p>
    </div>

    <!-- Mode Selection -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 max-w-4xl mx-auto">
        <!-- Template Mode -->
        <div class="mode-card">
            <label class="block h-full">
                <input type="radio" name="processing-mode" id="mode-template" value="template" class="hidden" checked>
                <div class="mode-card-inner h-full">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice text-blue-600 text-2xl"></i>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle text-2xl"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Mode Template</h3>
                    <p class="text-gray-600 text-sm">
                        Utilisez un fichier Excel généré par le générateur de templates.
                        Le format est déjà standardisé et prêt à l'emploi.
                    </p>
                </div>
            </label>
        </div>

        <!-- Automatic Mode -->
        <div class="mode-card">
            <label class="block h-full">
                <input type="radio" name="processing-mode" id="mode-auto" value="auto" class="hidden">
                <div class="mode-card-inner h-full">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-magic text-emerald-600 text-2xl"></i>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle text-2xl"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Mode Automatique <span
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-semibold ml-1">Nouveau</span>
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Traitement intelligent TCD vers template DHIS2.
                        Normalisation automatique, mapping dynamique, gestion des cellules fusionnées.
                    </p>
                </div>
            </label>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step-1">
            <div class="step-circle">1</div>
            <div class="step-label">Upload Excel</div>
        </div>
        <div class="step" id="step-2">
            <div class="step-circle">2</div>
            <div class="step-label">Traitement</div>
        </div>
        <div class="step" id="step-3">
            <div class="step-circle">3</div>
            <div class="step-label">Téléchargement</div>
        </div>
    </div>

    <!-- Upload Section (Template Mode) -->
    <div id="template-upload-section" class="card mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-upload text-white"></i>
            </div>
            Importez votre fichier Excel template
        </h2>

        <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="excel-dropzone">
            <div class="dz-message needsclick text-center">
                <i class="fas fa-file-excel text-6xl text-green-600 mb-4 block"></i>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Glissez-déposez votre fichier Excel ici</h3>
                <p class="text-gray-600 mb-4">ou cliquez pour sélectionner un fichier</p>
                <div class="flex items-center justify-center gap-3">
                    <span class="badge badge-primary">XLSX</span>
                    <span class="badge badge-success">XLS</span>
                    <span class="text-gray-500 text-sm">• Max 50 MB</span>
                </div>
            </div>
        </form>

        <div id="file-info" class="mt-6 hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-lg" id="uploaded-filename"></p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                Fichier chargé avec succès
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sheet Selection (hidden by default) -->
                <div id="sheet-selection" class="hidden mt-4 pt-4 border-t border-green-200">
                    <div class="form-group">
                        <label for="select-sheet" class="form-label flex items-center gap-2">
                            <i class="fas fa-layer-group text-blue-600"></i>
                            <span class="font-bold">Sélectionnez l'onglet à traiter</span>
                            <span id="sheet-count" class="badge badge-info ml-2"></span>
                        </label>
                        <select id="select-sheet" class="form-input">
                            <!-- Options ajoutées dynamiquement -->
                        </select>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Le fichier contient plusieurs onglets. Sélectionnez celui à traiter.
                        </p>
                    </div>
                </div>

                <!-- Data Type Selection -->
                <div id="data-type-selection" class="mt-4 pt-4 border-t border-green-200">
                    <label class="form-label flex items-center gap-2 mb-3">
                        <i class="fas fa-sliders-h text-purple-600"></i>
                        <span class="font-bold">Type de données</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Mode Normal -->
                        <label class="cursor-pointer">
                            <input type="radio" name="data-type" value="normal" class="hidden" checked>
                            <div
                                class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-all data-type-card">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-invoice text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">Données normales</h4>
                                        <p class="text-xs text-gray-600">Template généré</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600">
                                    Fichier Excel généré par le Générateur avec colonnes techniques pré-remplies.
                                </p>
                            </div>
                        </label>

                        <!-- Mode Tableau Croisé -->
                        <label class="cursor-pointer">
                            <input type="radio" name="data-type" value="pivot" class="hidden">
                            <div
                                class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition-all data-type-card">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-table text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">Tableau croisé</h4>
                                        <p class="text-xs text-gray-600">Structures en colonnes</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600">
                                    Tableau avec structures en colonnes et valeurs aux intersections.
                                </p>
                            </div>
                        </label>
                    </div>

                    <!-- Pivot Mode Options (hidden by default) -->
                    <div id="pivot-options" class="hidden mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <div class="flex items-start gap-3 mb-4">
                            <i class="fas fa-magic text-purple-600 mt-1 text-xl"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 mb-1 flex items-center gap-2">
                                    Mode Tableau Croisé Dynamique (TCD)
                                    <span
                                        class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-semibold">Auto-détection
                                        ✨</span>
                                </h4>
                                <p class="text-sm text-gray-700 mb-2">
                                    Les <strong>data elements sont automatiquement détectés</strong> depuis la première
                                    colonne de votre fichier.
                                </p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li><strong>Première colonne</strong> = noms des indicateurs/data elements (détectés
                                        automatiquement)</li>
                                    <li><strong>Autres colonnes</strong> = noms ou codes des organisations</li>
                                    <li><strong>Valeurs</strong> = données numériques aux intersections</li>
                                </ul>
                                <div class="mt-3 bg-white border border-purple-200 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1"><i
                                            class="fas fa-lightbulb text-yellow-500 mr-1"></i><strong>Exemple de format
                                            :</strong></p>
                                    <pre class="text-xs text-gray-700 font-mono">Indicateur          │ USSGB │ USTB │ UMN
────────────────────┼───────┼──────┼─────
Effectif Licence    │  450  │  320 │ 280
Effectif Master     │   85  │   62 │  58
Taux de réussite    │ 85.5  │ 90.2 │ 87.8</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Période (Required) -->
                        <div class="form-group mb-4">
                            <label for="pivot-period" class="form-label required">
                                <i class="fas fa-calendar mr-2"></i>Période
                            </label>
                            <input type="text" id="pivot-period" class="form-input"
                                placeholder="Ex: 2024, 202401, 2024Q1..." value="2024">
                            <p class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                Format selon le type : <code class="text-xs bg-gray-100 px-2 py-0.5 rounded">2024</code>
                                (annuel),
                                <code class="text-xs bg-gray-100 px-2 py-0.5 rounded">202401</code> (mensuel),
                                <code class="text-xs bg-gray-100 px-2 py-0.5 rounded">2024Q1</code> (trimestriel)
                            </p>
                        </div>

                        <!-- Data Element (Optional) -->
                        <div class="form-group">
                            <label for="pivot-data-element" class="form-label">
                                <i class="fas fa-chart-bar mr-2"></i>Data Element fixe <span
                                    class="text-gray-500 font-normal">(optionnel)</span>
                            </label>
                            <select id="pivot-data-element" class="form-input">
                                <option value="">-- Auto-détection depuis le fichier --</option>
                                <!-- Options chargées dynamiquement -->
                            </select>
                            <p class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                <strong>Laisser vide</strong> pour détecter automatiquement les data elements depuis la
                                première colonne.<br>
                                Sélectionner un DE uniquement si toutes les lignes utilisent le même indicateur.
                            </p>
                        </div>

                        <!-- Help Section -->
                        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-question-circle text-blue-600 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Besoin d'aide ?</strong> Consultez la
                                    <a href="#" class="underline hover:text-blue-900"
                                        onclick="NotificationManager.info('Documentation TCD multi-DE disponible dans MODE_TCD_MULTI_DE.md', 'Documentation'); return false;">documentation
                                        du mode TCD</a>
                                    pour plus d'exemples.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <div class="mt-6 flex justify-end">
                    <button id="btn-process" class="btn btn-primary btn-lg">
                        <i class="fas fa-cog mr-2"></i>Traiter le fichier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Mode Sections -->
    <div id="auto-sections" class="hidden">

        <!-- Étape 1: Upload Template DHIS2 -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-file-download text-white"></i>
                </div>
                Étape 1: Template DHIS2
            </h2>

            <div class="mb-6">
                <label class="form-label">Sélectionnez votre template DHIS2 généré</label>
                <input type="file" id="auto-template-input" accept=".xlsx,.xls" class="form-input">
                <p class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Le template doit être généré depuis le module "Générateur de Templates"
                </p>
            </div>

            <div id="auto-template-info" class="hidden">
                <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-check-circle text-emerald-600 text-xl mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900 mb-1">Template chargé</h4>
                            <p class="text-sm text-gray-700" id="auto-template-filename"></p>
                            <p class="text-sm text-gray-600 mt-2">
                                <strong>Lignes:</strong> <span id="auto-template-rows"></span> |
                                <strong>Organisations:</strong> <span id="auto-template-orgs"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 2: Upload TCD -->
        <div id="auto-step2" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-table text-white"></i>
                </div>
                Étape 2: Fichier TCD
            </h2>

            <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="auto-tcd-dropzone">
                <div class="dz-message needsclick">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Déposez votre fichier TCD ici</h3>
                    <p class="text-gray-500">ou cliquez pour sélectionner</p>
                    <p class="text-sm text-gray-400 mt-2">Excel (.xlsx, .xls)</p>
                </div>
            </form>

            <div id="auto-tcd-info" class="mt-6 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-file-excel text-blue-600 text-2xl"></i>
                        <div class="flex-1">
                            <p class="font-bold text-gray-900 text-lg" id="auto-tcd-filename"></p>
                            <p class="text-sm text-gray-600 mt-1">
                                <strong>Onglets:</strong> <span id="auto-tcd-sheets"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 3: Configuration -->
        <div id="auto-step3" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-cog text-white"></i>
                </div>
                Étape 3: Configuration
            </h2>

            <!-- Sélection onglet TCD -->
            <div class="form-group mb-6">
                <label for="auto-sheet-select" class="form-label required">
                    <i class="fas fa-layer-group mr-2"></i>Onglet TCD à traiter
                </label>
                <select id="auto-sheet-select" class="form-input">
                    <option value="">-- Sélectionnez un onglet --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2" id="auto-sheet-info"></p>
            </div>

            <!-- Colonne Data Element -->
            <div class="form-group mb-6">
                <label for="auto-col-de" class="form-label required">
                    <i class="fas fa-columns mr-2"></i>Colonne Data Element
                </label>
                <select id="auto-col-de" class="form-input">
                    <option value="">-- Sélectionnez la colonne --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    Colonne contenant les variables (ex: CYCLE, DIPLÔME, NATIONALITÉ)
                </p>
            </div>

            <!-- Colonne Code Établissement -->
            <div class="form-group mb-6">
                <label for="auto-col-code-etab" class="form-label">
                    <i class="fas fa-barcode mr-2"></i>Colonne Code Établissement (optionnel)
                </label>
                <select id="auto-col-code-etab" class="form-input">
                    <option value="">-- Aucun (pas de mapping auto) --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    Colonne contenant les codes pour le mapping automatique (ex: code_ets, CODE_ETAB)
                </p>
            </div>

            <!-- Colonnes Catégories -->
            <div class="form-group mb-6">
                <label class="form-label required">
                    <i class="fas fa-tags mr-2"></i>Colonnes de Catégories (Option Combo)
                </label>
                <div id="auto-cat-cols-container" class="space-y-2 mb-2">
                    <!-- Dynamically filled -->
                </div>
                <button type="button" class="btn btn-sm btn-outline text-blue-600 border-blue-600 hover:bg-blue-50"
                    id="btn-add-cat-col">
                    <i class="fas fa-plus mr-1"></i>Ajouter une colonne
                </button>
                <p class="text-sm text-gray-600 mt-2">
                    Sélectionnez les colonnes constituant la combinaison de catégorie (ex: Sexe, Age).
                </p>
            </div>

            <!-- Période -->
            <div class="form-group mb-6">
                <label for="auto-period" class="form-label required">
                    <i class="fas fa-calendar mr-2"></i>Période
                </label>
                <input type="text" id="auto-period" class="form-input" placeholder="Ex: 2024, 202401..." value="2024">
                <p class="text-sm text-gray-600 mt-2">Format: YYYY pour année, YYYYMM pour mois</p>
            </div>
        </div>

        <!-- Étape 4: Mappings -->
        <div id="auto-step4" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-link text-white"></i>
                </div>
                Étape 4: Mappings
            </h2>

            <!-- Mapping Établissements -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-building mr-2"></i>Mapping Établissements
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Associez les acronymes du TCD aux noms complets du template
                </p>

                <div id="auto-org-mappings" class="space-y-3">
                    <!-- Dynamiquement rempli -->
                </div>

                <button type="button" onclick="addAutoOrgMapping()" class="btn-secondary mt-4">
                    <i class="fas fa-plus mr-2"></i>Ajouter un mapping
                </button>
            </div>

            <!-- Mapping Data Elements -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-database mr-2"></i>Mapping Data Elements
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Associez les valeurs du TCD aux Data Elements du template (Section + Nom)
                </p>

                <div id="auto-de-mappings" class="space-y-3">
                    <!-- Dynamiquement rempli -->
                </div>

                <button type="button" onclick="addAutoDEMapping()" class="btn-secondary mt-4">
                    <i class="fas fa-plus mr-2"></i>Ajouter un mapping
                </button>
            </div>

            <!-- Bouton Traiter -->
            <div class="flex justify-end mt-8">
                <button type="button" onclick="processAuto()" class="btn-primary">
                    <i class="fas fa-cogs mr-2"></i>Traiter les données
                </button>
            </div>
        </div>

        <!-- Étape 5: Rapport -->
        <div id="auto-step5" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-check-circle text-white"></i>
                </div>
                Rapport de Traitement
            </h2>

            <!-- Statistiques -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2" id="auto-stat-lignes">0</div>
                    <div class="text-sm opacity-90">Lignes traitées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-green-600" id="auto-stat-valeurs">0</div>
                    <div class="text-sm opacity-90">Valeurs insérées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-orange-600" id="auto-stat-org-nm">0</div>
                    <div class="text-sm opacity-90">Orgs non mappées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-red-600" id="auto-stat-de-nm">0</div>
                    <div class="text-sm opacity-90">DEs non mappés</div>
                </div>
            </div>

            <!-- Détails erreurs -->
            <div id="auto-errors-container" class="hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-orange-600"></i>
                    Détails des erreurs
                </h3>

                <div id="auto-unmapped-orgs" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Organisations non mappées :</h4>
                    <div id="auto-unmapped-orgs-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <div id="auto-unmapped-des" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Data Elements non mappés :</h4>
                    <div id="auto-unmapped-des-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <div id="auto-not-found" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Combinaisons non trouvées (premières 10) :</h4>
                    <div id="auto-not-found-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>
            </div>

            <!-- Preview -->
            <div class="mt-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-eye mr-2"></i>Aperçu des données (10 premières)
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Element
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Organisation
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">COC</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Période</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valeur</th>
                            </tr>
                        </thead>
                        <tbody id="auto-preview-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamiquement rempli -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- OLD TCD-TEMP: placeholder (sera supprimé après) -->
    <div id="tcd-sections-temp" class="hidden">
        <!-- Dataset Selection -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-database text-white"></i>
                </div>
                Étape 1: Sélectionnez le dataset
            </h2>

            <div class="form-group">
                <label for="mapping-dataset" class="form-label">
                    <i class="fas fa-table mr-2"></i>Dataset DHIS2
                </label>
                <select id="mapping-dataset" class="form-input">
                    <option value="">-- Sélectionnez un dataset --</option>
                </select>
            </div>

            <div id="dataset-info" class="mt-4 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-bold text-gray-900 mb-2">Informations du dataset</h4>
                    <div class="text-sm text-gray-700">
                        <p><strong>Type de période:</strong> <span id="dataset-period-type"></span></p>
                        <p><strong>Catégories requises:</strong> <span id="dataset-categories"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload for Mapping -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-upload text-white"></i>
                </div>
                Étape 2: Importez votre fichier Excel brut
            </h2>

            <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="mapping-dropzone">
                <div class="dz-message needsclick text-center">
                    <i class="fas fa-file-excel text-6xl text-green-600 mb-4 block"></i>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Glissez-déposez votre fichier Excel brut</h3>
                    <p class="text-gray-600 mb-4">ou cliquez pour sélectionner un fichier</p>
                    <div class="flex items-center justify-center gap-3">
                        <span class="badge badge-primary">XLSX</span>
                        <span class="badge badge-success">XLS</span>
                        <span class="text-gray-500 text-sm">• Max 50 MB</span>
                    </div>
                </div>
            </form>

            <div id="mapping-file-info" class="mt-6 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-lg" id="mapping-filename"></p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                Fichier chargé - Prêt pour le mapping
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sheet Selection for Mapping -->
                <div class="mt-4 form-group">
                    <label for="mapping-select-sheet" class="form-label">
                        <i class="fas fa-layer-group mr-2"></i>Sélectionnez l'onglet à traiter
                    </label>
                    <select id="mapping-select-sheet" class="form-input">
                        <option value="">-- Chargement des onglets... --</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                        Le fichier contient plusieurs onglets. Sélectionnez celui contenant vos données.
                    </p>
                </div>
            </div>
        </div>

        <!-- AI Analysis Button -->
        <div id="ai-analysis-section" class="card mb-8 hidden">
            <div
                class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        Assistant IA
                    </h3>
                    <p class="text-purple-100">Laissez l'IA analyser votre fichier et configurer le mapping
                        automatiquement.</p>
                </div>
                <button id="btn-analyze-ai" class="btn bg-white text-purple-600 hover:bg-purple-50 border-none">
                    <i class="fas fa-sparkles mr-2"></i>Analyser avec IA
                </button>
            </div>
            <div id="ai-result-badge" class="mt-4 hidden">
                <span
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                    <i class="fas fa-check-circle mr-2"></i>
                    Configuration suggérée (Confiance: <span id="ai-confidence"></span>%)
                </span>
                <p class="text-sm text-gray-600 mt-2" id="ai-reasoning"></p>
            </div>
        </div>

        <!-- Column Mapping -->
        <div id="mapping-config" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-arrows-alt-h text-white"></i>
                </div>
                Étape 3: Mappez les colonnes
            </h2>

            <div class="space-y-4">
                <!-- Processing Mode Selection -->
                <div class="form-group">
                    <label class="form-label required">
                        <i class="fas fa-cogs mr-2"></i>Mode de traitement
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label
                            class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 transition">
                            <input type="radio" name="processing-mode-mapping" value="values" class="mr-3" checked>
                            <div>
                                <div class="font-bold text-gray-900">Mode Valeurs</div>
                                <div class="text-sm text-gray-600">Fichier avec valeurs agrégées (colonnes numériques)
                                </div>
                            </div>
                        </label>
                        <label
                            class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-400 transition">
                            <input type="radio" name="processing-mode-mapping" value="count" class="mr-3">
                            <div>
                                <div class="font-bold text-gray-900">Mode Comptage</div>
                                <div class="text-sm text-gray-600">Enregistrements individuels (compte automatiquement)
                                </div>
                            </div>
                        </label>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <strong>Mode Valeurs:</strong> Pour fichiers pré-agrégés (ex: Faculté, Sexe, Effectif=45)<br>
                        <strong>Mode Comptage:</strong> Pour données brutes (ex: 1 ligne = 1 étudiant → compte
                        automatique)
                    </p>
                </div>

                <!-- Period Mapping -->
                <div class="form-group">
                    <label for="mapping-period" class="form-label required">
                        <i class="fas fa-calendar mr-2"></i>Période
                    </label>
                    <input type="text" id="mapping-period" class="form-input" placeholder="Ex: 202401, 2024Q1, 2024">
                    <p class="text-sm text-gray-600 mt-1">
                        Format selon le type de période du dataset
                    </p>
                </div>

                <!-- Organization Mapping -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-hospital text-blue-600"></i>
                        Organisation Unit (UO)
                        <span class="text-red-500">*</span>
                    </h3>

                    <div class="flex gap-4 mb-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="org-mode" value="column" class="form-radio text-blue-600" checked
                                onchange="toggleOrgMode()">
                            <span class="ml-2 text-gray-700">Colonne Excel</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="org-mode" value="fixed" class="form-radio text-blue-600"
                                onchange="toggleOrgMode()">
                            <span class="ml-2 text-gray-700">Valeur Fixe (DHIS2)</span>
                        </label>
                    </div>

                    <!-- Column Mode -->
                    <div id="org-mode-column">
                        <select id="map-org" class="form-input w-full">
                            <option value="">-- Sélectionnez une colonne --</option>
                        </select>
                    </div>

                    <!-- Fixed Mode -->
                    <div id="org-mode-fixed" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filtrer par
                                    Groupe</label>
                                <select id="filter-org-group"
                                    class="form-select text-sm w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                    onchange="updateOrgUnitList()">
                                    <option value="">Tous les groupes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filtrer par
                                    Niveau</label>
                                <select id="filter-org-level"
                                    class="form-select text-sm w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                    onchange="updateOrgUnitList()">
                                    <option value="">Tous les niveaux</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Sélectionner
                                l'Organisation</label>
                            <select id="map-org-fixed"
                                class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <option value="">-- Sélectionnez une organisation --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="org-count-hint"></p>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Category & Data Element Mappings -->
                <div id="category-mappings"></div>

                <!-- Process Button -->
                <div class="mt-8 flex justify-end">
                    <button id="btn-process-mapping" class="btn btn-primary btn-lg">
                        <i class="fas fa-play-circle mr-2"></i>
                        Traiter le fichier avec mapping
                    </button>
                </div>
            </div>
        </div>

        <!-- Pivoted Format Mapping -->
        <div id="pivoted-mapping" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-table text-white"></i>
                </div>
                Format Pivoté Détecté - Mapping des Data Elements
            </h2>

            <!-- Explanation -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-bold text-blue-900 mb-2">Format Pivoté Détecté</h3>
                        <p class="text-sm text-blue-800 mb-2">
                            Les data elements sont contenus dans les <strong>valeurs des colonnes</strong>, pas dans les
                            noms des colonnes.
                        </p>
                        <p class="text-sm text-blue-700">
                            <strong>Exemple:</strong> Dans la colonne "Cycle", les valeurs "1er cycle", "2e cycle", "3e
                            cycle" sont des data elements DHIS2 distincts.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">Total Trouvés</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-total">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">Auto-matchés</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-matched">0</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">À Mapper</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-unmatched">0</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">Sections</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-sections">0</p>
                </div>
            </div>

            <div id="pivoted-sections-container"></div>

            <div class="mt-6 flex justify-between items-center">
                <button onclick="autoMatchPivoted()" class="btn btn-secondary">
                    <i class="fas fa-magic mr-2"></i>
                    Auto-Match (Fuzzy)
                </button>
                <button id="btn-validate-pivoted" class="btn btn-primary btn-lg">
                    <i class="fas fa-check mr-2"></i>
                    Valider et Traiter
                </button>
            </div>
        </div>
    </div>

    <!-- TCD Mode Sections -->
    <div id="tcd-sections" class="hidden">
        <!-- Step 1: File Upload & Analysis -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-upload text-white"></i>
                </div>
                Étape 1: Importez votre fichier TCD
            </h2>

            <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="tcd-dropzone">
                <div class="dz-message needsclick text-center">
                    <i class="fas fa-file-excel text-6xl text-purple-600 mb-4 block"></i>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Glissez-déposez votre fichier TCD</h3>
                    <p class="text-gray-600 mb-4">ou cliquez pour sélectionner un fichier</p>
                    <div class="flex items-center justify-center gap-3">
                        <span class="badge badge-primary">XLSX</span>
                        <span class="badge badge-success">XLS</span>
                        <span class="text-gray-500 text-sm">• Max 50 MB</span>
                    </div>
                </div>
            </form>

            <div id="tcd-file-info" class="mt-6 hidden">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-lg" id="tcd-filename"></p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                Fichier chargé - Prêt pour l'analyse
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Analyze Button -->
                <div class="mt-4 flex justify-end">
                    <button id="btn-analyze-tcd" class="btn btn-primary">
                        <i class="fas fa-search mr-2"></i>Analyser le fichier
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Sheet & Configuration -->
        <div id="tcd-config-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-cog text-white"></i>
                </div>
                Étape 2: Configuration du traitement
            </h2>

            <!-- Sheet Selection -->
            <div class="form-group mb-6">
                <label for="tcd-sheet" class="form-label required">
                    <i class="fas fa-layer-group mr-2"></i>Onglet à traiter
                </label>
                <select id="tcd-sheet" class="form-input">
                    <option value="">-- Sélectionnez un onglet --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2" id="tcd-sheet-info"></p>
            </div>

            <!-- Data Element Column -->
            <div class="form-group mb-6">
                <label for="tcd-col-de" class="form-label required">
                    <i class="fas fa-columns mr-2"></i>Colonne contenant les Data Elements
                </label>
                <select id="tcd-col-de" class="form-input">
                    <option value="">-- Sélectionnez une colonne --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Cette colonne contient les noms des indicateurs (ex: CYCLE, DIPLOME, etc.)
                </p>
            </div>

            <!-- Period -->
            <div class="form-group mb-6">
                <label for="tcd-period" class="form-label required">
                    <i class="fas fa-calendar mr-2"></i>Période
                </label>
                <input type="text" id="tcd-period" class="form-input" placeholder="Ex: 2024, 202401..." value="2024">
            </div>

            <!-- Organization Mode -->
            <div class="form-group mb-6">
                <label class="form-label required">
                    <i class="fas fa-building mr-2"></i>Mode d'identification des organisations
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="cursor-pointer">
                        <input type="radio" name="tcd-org-mode" value="code" class="hidden" checked>
                        <div class="radio-card">
                            <i class="fas fa-barcode text-2xl mb-2"></i>
                            <div class="font-bold">Par Code</div>
                            <div class="text-xs text-gray-600 mt-1">Utiliser les codes DHIS2</div>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="tcd-org-mode" value="name" class="hidden">
                        <div class="radio-card">
                            <i class="fas fa-tag text-2xl mb-2"></i>
                            <div class="font-bold">Par Nom</div>
                            <div class="text-xs text-gray-600 mt-1">Utiliser les noms DHIS2</div>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="tcd-org-mode" value="fixed" class="hidden">
                        <div class="radio-card">
                            <i class="fas fa-map-pin text-2xl mb-2"></i>
                            <div class="font-bold">Fixe</div>
                            <div class="text-xs text-gray-600 mt-1">Une seule organisation</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Fixed Org Unit (hidden by default) -->
            <div id="tcd-fixed-org-section" class="form-group mb-6 hidden">
                <label for="tcd-fixed-org" class="form-label required">
                    <i class="fas fa-building mr-2"></i>Organisation fixe
                </label>
                <select id="tcd-fixed-org" class="form-input">
                    <option value="">-- Sélectionnez une organisation --</option>
                </select>
            </div>

            <!-- Generate Suggestions Button -->
            <div class="flex justify-end">
                <button id="btn-tcd-suggestions" class="btn btn-primary">
                    <i class="fas fa-magic mr-2"></i>Générer les suggestions de mapping
                </button>
            </div>
        </div>

        <!-- Step 3: Mapping Configuration -->
        <div id="tcd-mapping-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exchange-alt text-white"></i>
                </div>
                Étape 3: Configuration des mappings
            </h2>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-lightbulb text-blue-600 text-xl"></i>
                    <div class="text-sm text-blue-800">
                        <strong>Mapping intelligent :</strong> Les suggestions sont générées automatiquement en
                        analysant
                        vos données et les métadonnées DHIS2. Vous pouvez les modifier si nécessaire.
                    </div>
                </div>
            </div>

            <!-- Data Elements Mapping -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-purple-600"></i>
                    Mapping des Data Elements
                </h3>
                <div id="tcd-de-mapping-list" class="space-y-3">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Organizations Mapping -->
            <div class="mb-8" id="tcd-org-mapping-container">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-building text-purple-600"></i>
                    Mapping des Organisations
                </h3>
                <div id="tcd-org-mapping-list" class="space-y-3">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Preview & Process Button -->
            <div class="flex justify-between items-center">
                <button id="btn-tcd-preview" class="btn btn-secondary">
                    <i class="fas fa-eye mr-2"></i>Prévisualiser
                </button>
                <button id="btn-tcd-process" class="btn btn-primary btn-lg">
                    <i class="fas fa-cog mr-2"></i>Traiter le fichier
                </button>
            </div>
        </div>

        <!-- Step 4: Preview Section -->
        <div id="tcd-preview-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-eye text-white"></i>
                </div>
                Prévisualisation des données
            </h2>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Organisation</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Data Element</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Catégories</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Valeur</th>
                        </tr>
                    </thead>
                    <tbody id="tcd-preview-tbody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-center">
                <button id="btn-tcd-confirm" class="btn btn-success btn-lg">
                    <i class="fas fa-check mr-2"></i>Confirmer et Générer le JSON
                </button>
            </div>
        </div>

        <!-- Step 5: Processing Report -->
        <div id="tcd-report-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-white"></i>
                </div>
                Rapport de traitement
            </h2>

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2" id="tcd-stat-lignes">0</div>
                    <div class="text-sm opacity-90">Lignes traitées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-green-600" id="tcd-stat-valeurs">0</div>
                    <div class="text-sm opacity-90">Valeurs insérées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-orange-600" id="tcd-stat-org-nm">0</div>
                    <div class="text-sm opacity-90">Orgs non mappées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-red-600" id="tcd-stat-de-nm">0</div>
                    <div class="text-sm opacity-90">DEs non mappés</div>
                </div>
            </div>

            <!-- Errors -->
            <div id="tcd-errors-container" class="hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-orange-600"></i>
                    Détails des erreurs
                </h3>

                <!-- Unmapped Orgs -->
                <div id="tcd-unmapped-orgs" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Organisations non mappées :</h4>
                    <div id="tcd-unmapped-orgs-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <!-- Unmapped DEs -->
                <div id="tcd-unmapped-des" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Data Elements non mappés :</h4>
                    <div id="tcd-unmapped-des-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="card mb-8 hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-chart-bar text-white"></i>
            </div>
            Résultats du traitement
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-total">0</div>
                <div class="text-sm opacity-90">Lignes traitées</div>
            </div>
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-valid">0</div>
                <div class="text-sm opacity-90">Valeurs valides</div>
            </div>
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-errors">0</div>
                <div class="text-sm opacity-90">Erreurs</div>
            </div>
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-error-rate">0%</div>
                <div class="text-sm opacity-90">Taux d'erreur</div>
            </div>
        </div>

        <div id="error-details" class="mb-6 hidden">
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle text-2xl mr-3"></i>
                <div>
                    <h3 class="font-bold text-lg mb-2">Détails des erreurs</h3>
                    <div id="error-list"></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="font-bold text-gray-900 mb-4 text-lg flex items-center gap-2">
                <i class="fas fa-eye text-blue-600"></i>
                Aperçu des données (10 premières lignes)
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">DataElement</th>
                            <th class="px-4 py-3 text-left font-semibold">Period</th>
                            <th class="px-4 py-3 text-left font-semibold">OrgUnit</th>
                            <th class="px-4 py-3 text-left font-semibold">Value</th>
                        </tr>
                    </thead>
                    <tbody id="preview-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Download Section -->
    <div id="download-section" class="card hidden">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-8 mb-6">
            <h2 class="text-3xl font-bold mb-3 flex items-center gap-3">
                <i class="fas fa-check-circle"></i>
                Payload généré avec succès !
            </h2>
            <p class="text-green-50 mb-6" id="json-info"></p>
            <div class="flex gap-3">
                <button id="btn-preview-json" class="btn bg-white text-green-700 hover:bg-gray-100">
                    <i class="fas fa-eye mr-2"></i>Prévisualiser
                </button>
                <button id="btn-download-json" class="btn bg-white text-green-700 hover:bg-gray-100">
                    <i class="fas fa-download mr-2"></i>Télécharger JSON
                </button>
                <button id="btn-download-csv-names" class="btn bg-white text-green-700 hover:bg-gray-100">
                    <i class="fas fa-file-csv mr-2"></i>Télécharger CSV (noms)
                </button>
                {% if session.get('dhis2_url') %}
                <button id="btn-send-dhis2" class="btn bg-blue-600 text-white hover:bg-blue-700 border-2 border-white">
                    <i class="fas fa-paper-plane mr-2"></i>Envoyer vers DHIS2
                </button>
                {% endif %}
            </div>
        </div>

        <div id="json-preview-container" class="hidden mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-900 text-lg flex items-center gap-2">
                    <i class="fas fa-code text-purple-600"></i>
                    Aperçu du JSON
                </h3>
                <button id="btn-close-preview" class="btn btn-sm bg-gray-500 text-white hover:bg-gray-600">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
            <div class="json-preview">
                <pre id="json-content"></pre>
            </div>
        </div>

        <div class="text-center">
            <button id="btn-new-calculation" class="btn btn-outline">
                <i class="fas fa-redo mr-2"></i>Nouveau calcul
            </button>
        </div>
    </div>

    <!-- Instructions -->
    <div class="card bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-info-circle text-white"></i>
            </div>
            Instructions
        </h3>
        <ul class="space-y-3 text-gray-700">
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-blue-600 text-lg flex-shrink-0"></i>
                <span>Utilisez un fichier Excel généré par le <strong>Générateur de Templates</strong></span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-blue-600 text-lg flex-shrink-0"></i>
                <span>Assurez-vous d'avoir rempli la colonne <code
                        class="bg-white px-2 py-1 rounded font-mono text-sm">VALEUR</code></span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-blue-600 text-lg flex-shrink-0"></i>
                <span>Le fichier JSON généré peut être importé directement dans DHIS2</span>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script>
    Dropzone.autoDiscover = false;

    let templateDropzone, mappingDropzone;
    let excelColumns = [];
    let datasetCategories = [];
    let datasetElements = [];
    let metadataFilters = {
        org_unit_groups: [],
        org_unit_levels: [],
        data_element_groups: []
    };

    document.addEventListener('DOMContentLoaded', function () {
        initializeDropzone();
        loadMetadataFilters();

        // Event listeners
        // Mode switching
        document.querySelectorAll('input[name="processing-mode"]').forEach(radio => {
            radio.addEventListener('change', function () {
                // Hide all sections
                document.getElementById('template-upload-section').classList.add('hidden');
                document.getElementById('auto-sections').classList.add('hidden');

                // Show selected section
                if (this.value === 'template') {
                    document.getElementById('template-upload-section').classList.remove('hidden');
                } else if (this.value === 'auto') {
                    document.getElementById('auto-sections').classList.remove('hidden');
                }
            });
        });

        document.getElementById('mapping-dataset').addEventListener('change', onDatasetChange);
        document.getElementById('btn-process').addEventListener('click', processFile);
        document.getElementById('btn-process-mapping').addEventListener('click', processFile);
        document.getElementById('btn-new-calculation').addEventListener('click', () => window.location.reload());

        // JSON Preview/Download buttons
        document.getElementById('btn-preview-json').addEventListener('click', previewJson);
        document.getElementById('btn-close-preview').addEventListener('click', closeJsonPreview);
        document.getElementById('btn-download-json').addEventListener('click', downloadJson);
        const btnDownloadCsvNames = document.getElementById('btn-download-csv-names');
        if (btnDownloadCsvNames) {
            btnDownloadCsvNames.addEventListener('click', function () {
                window.open('/calculator/api/download-csv-names', '_blank');
            });
        }
        const btnSend = document.getElementById('btn-send-dhis2');
        if (btnSend) btnSend.addEventListener('click', sendToDhis2);

        // AI Analysis
        document.getElementById('btn-analyze-ai').addEventListener('click', analyzeWithAI);

        // Data type selection event listeners
        document.querySelectorAll('input[name="data-type"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const pivotOptions = document.getElementById('pivot-options');
                if (this.value === 'pivot') {
                    pivotOptions.classList.remove('hidden');
                    loadDataElements();
                } else {
                    pivotOptions.classList.add('hidden');
                }
            });
        });

        // Load datasets
        fetch('/configuration/api/datasets')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('mapping-dataset');
                data.datasets.forEach(ds => {
                    const option = document.createElement('option');
                    option.value = ds.id;
                    option.textContent = ds.name;
                    select.appendChild(option);
                });
            })
            .catch(() => NotificationManager.error('Erreur lors du chargement des datasets'));
    });

    function loadMetadataFilters() {
        fetch('/calculator/api/get-metadata-filters')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    metadataFilters = data;

                    // Populate Org Unit Filters
                    const groupSelect = document.getElementById('filter-org-group');
                    data.org_unit_groups.forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g.id;
                        opt.textContent = g.name;
                        groupSelect.appendChild(opt);
                    });

                    const levelSelect = document.getElementById('filter-org-level');
                    data.org_unit_levels.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.level;
                        opt.textContent = l.name;
                        levelSelect.appendChild(opt);
                    });
                }
            })
            .catch(e => console.error('Error loading filters:', e));
    }

    function toggleOrgMode() {
        const mode = document.querySelector('input[name="org-mode"]:checked').value;
        if (mode === 'column') {
            document.getElementById('org-mode-column').classList.remove('hidden');
            document.getElementById('org-mode-fixed').classList.add('hidden');
        } else {
            document.getElementById('org-mode-column').classList.add('hidden');
            document.getElementById('org-mode-fixed').classList.remove('hidden');
            // Load initial list if empty
            if (document.getElementById('map-org-fixed').options.length <= 1) {
                updateOrgUnitList();
            }
        }
    }

    function updateOrgUnitList() {
        const groupId = document.getElementById('filter-org-group').value;
        const level = document.getElementById('filter-org-level').value;
        const select = document.getElementById('map-org-fixed');
        const hint = document.getElementById('org-count-hint');

        select.innerHTML = '<option value="">Chargement...</option>';
        select.disabled = true;

        fetch('/calculator/api/get-filtered-org-units', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ group_id: groupId, level: level })
        })
            .then(r => r.json())
            .then(data => {
                select.innerHTML = '<option value="">-- Sélectionnez une organisation --</option>';
                if (data.success) {
                    data.org_units.forEach(ou => {
                        const opt = document.createElement('option');
                        opt.value = ou.id;
                        opt.textContent = ou.name;
                        select.appendChild(opt);
                    });
                    hint.textContent = `${data.count} organisation(s) trouvée(s)`;
                    if (data.count >= 1000) {
                        hint.textContent += ' (Limité à 1000)';
                    }
                }
            })
            .catch(e => {
                console.error(e);
                select.innerHTML = '<option value="">Erreur</option>';
            })
            .finally(() => {
                select.disabled = false;
            });
    }

    function initializeDropzone() {
        // Template dropzone
        templateDropzone = new Dropzone('#excel-dropzone', {
            url: "{{ url_for('calculator.upload_excel') }}",
            maxFiles: 1,
            maxFilesize: 50,
            acceptedFiles: '.xlsx,.xls',
            addRemoveLinks: true,
            dictDefaultMessage: '',

            init: function () {
                this.on("success", async function (file, response) {
                    if (response.success) {
                        document.getElementById('uploaded-filename').textContent = response.filename;
                        document.getElementById('file-info').classList.remove('hidden');
                        setStep(1, 'completed');
                        NotificationManager.success('Fichier chargé avec succès');

                        // Charger les onglets
                        await loadExcelSheets();
                    }
                });

                this.on("error", function (file, errorMessage) {
                    const msg = typeof errorMessage === 'object' ? errorMessage.error : errorMessage;
                    NotificationManager.error(msg);
                    this.removeFile(file);
                });
            }
        });

        // Mapping dropzone
        mappingDropzone = new Dropzone('#mapping-dropzone', {
            url: "{{ url_for('calculator.upload_excel') }}",
            maxFiles: 1,
            maxFilesize: 50,
            acceptedFiles: '.xlsx,.xls',
            addRemoveLinks: true,
            dictDefaultMessage: '',

            init: function () {
                this.on("success", function (file, response) {
                    if (response.success) {
                        document.getElementById('mapping-filename').textContent = response.filename;
                        document.getElementById('mapping-file-info').classList.remove('hidden');
                        document.getElementById('ai-analysis-section').classList.remove('hidden'); // Show AI button
                        NotificationManager.success('Fichier chargé avec succès');

                        // Charger les onglets pour le mode mapping (qui chargera ensuite les colonnes)
                        loadMappingSheets();
                    }
                });

                this.on("error", function (file, errorMessage) {
                    const msg = typeof errorMessage === 'object' ? errorMessage.error : errorMessage;
                    NotificationManager.error(msg);
                    this.removeFile(file);
                });
            }
        });
    }

    function analyzeWithAI() {
        if (!mappingDropzone.files || mappingDropzone.files.length === 0) {
            NotificationManager.error('Veuillez d\'abord charger un fichier Excel');
            return;
        }

        const file = mappingDropzone.files[0];
        const formData = new FormData();
        formData.append('file', file);

        LoadingOverlay.show('Analyse IA en cours...');

        // D'abord essayer de détecter le format pivoté
        fetch('/calculator/api/extract-pivoted-data-elements', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.format === 'pivoted' && data.statistics.matched_with_dhis2 > 0) {
                    // Format pivoté détecté avec des matches
                    LoadingOverlay.hide();
                    showPivotedMappingInterface(data);

                    const colsList = data.data_element_columns.join(', ');
                    NotificationManager.success(
                        `✓ Format pivoté détecté!\n` +
                        `${data.statistics.matched_with_dhis2} DE auto-matchés, ${data.statistics.unmatched} à mapper.\n` +
                        `Colonnes DE: ${colsList}`
                    );
                } else {
                    // Format classique, utiliser l'analyse normale
                    return fetch('/calculator/api/analyze-file', {
                        method: 'POST',
                        body: formData
                    });
                }
            })
            .then(r => r ? r.json() : null)
            .then(data => {
                if (data) {
                    if (data.success) {
                        applyAISuggestions(data);
                        NotificationManager.success('Analyse terminée ! Configuration appliquée.');
                    } else {
                        NotificationManager.error(data.error || 'Erreur lors de l\'analyse');
                    }
                }
            })
            .catch(e => NotificationManager.error('Erreur réseau: ' + e.message))
            .finally(() => LoadingOverlay.hide());
    }

    function applyAISuggestions(data) {
        console.log('AI Analysis Result:', data);

        // Show AI result badge with confidence color
        const badge = document.getElementById('ai-result-badge');
        badge.classList.remove('hidden');

        const confidence = Math.round(data.confidence * 100);
        document.getElementById('ai-confidence').textContent = confidence;

        // Color code based on confidence
        const badgeElement = badge.querySelector('span');
        if (confidence >= 80) {
            badgeElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
        } else if (confidence >= 60) {
            badgeElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
        } else {
            badgeElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
        }

        // Show reasoning
        let reasoningHtml = `<strong>Analyse:</strong> ${data.reasoning}`;

        // Show warnings if any
        if (data.warnings && data.warnings.length > 0) {
            reasoningHtml += `<br><br><strong class="text-orange-600">⚠️ Avertissements:</strong><ul class="list-disc ml-5 mt-1">`;
            data.warnings.forEach(w => {
                reasoningHtml += `<li>${w}</li>`;
            });
            reasoningHtml += `</ul>`;
        }

        document.getElementById('ai-reasoning').innerHTML = reasoningHtml;

        // Show mapping configuration section
        document.getElementById('mapping-config').classList.remove('hidden');

        // Set Processing Mode
        const modeRadio = document.querySelector(`input[name="processing-mode-mapping"][value="${data.processing_mode}"]`);
        if (modeRadio) {
            modeRadio.checked = true;
            console.log(`Set processing mode to: ${data.processing_mode}`);
        }

        // Apply Column Mappings
        if (data.mapping) {
            const m = data.mapping;
            console.log('Applying mappings:', m);

            // Org Unit
            if (m.org_unit) {
                const orgModeRadio = document.querySelector('input[name="org-mode"][value="column"]');
                if (orgModeRadio) {
                    orgModeRadio.checked = true;
                    toggleOrgMode();
                    setTimeout(() => {
                        setSelectValue('map-org', m.org_unit);
                        console.log(`Mapped org_unit to column: ${m.org_unit}`);
                    }, 100);
                }
            }

            // Period - Try to extract from data if it's a column
            if (m.period) {
                console.log(`Period column detected: ${m.period} (manual mapping may be required)`);
                NotificationManager.info(`Période détectée dans la colonne "${m.period}". Vérifiez le format dans les données.`);
            }

            // Data Element
            if (m.data_element) {
                setTimeout(() => {
                    const deSelect = document.getElementById('map-data-element');
                    if (deSelect) {
                        setSelectValue('map-data-element', m.data_element);
                        console.log(`Mapped data_element to column: ${m.data_element}`);
                    }
                }, 100);
            }

            // Value Column (for values mode)
            if (data.processing_mode === 'values' && m.value) {
                setTimeout(() => {
                    const valueSelect = document.getElementById('map-value-column');
                    if (valueSelect) {
                        setSelectValue('map-value-column', m.value);
                        console.log(`Mapped value to column: ${m.value}`);
                    }
                }, 100);
            }

            // Categories - Apply to category mapping dropdowns
            if (m.categories && Array.isArray(m.categories) && m.categories.length > 0) {
                setTimeout(() => {
                    const catMappings = document.querySelectorAll('.category-mapping');
                    m.categories.forEach((catCol, idx) => {
                        if (catMappings[idx]) {
                            setSelectValue(catMappings[idx].id, catCol);
                            console.log(`Mapped category ${idx} to column: ${catCol}`);
                        }
                    });

                    if (m.categories.length > 0) {
                        NotificationManager.info(`${m.categories.length} catégorie(s) détectée(s): ${m.categories.join(', ')}`);
                    }
                }, 200);
            }
        }

        // Show success message with confidence level
        if (confidence >= 80) {
            NotificationManager.success(`Analyse IA complète! Confiance élevée (${confidence}%). Vérifiez les mappings suggérés.`);
        } else if (confidence >= 60) {
            NotificationManager.warning(`Analyse IA terminée avec confiance moyenne (${confidence}%). Vérifiez attentivement les mappings.`);
        } else {
            NotificationManager.warning(`Analyse IA terminée mais confiance faible (${confidence}%). Corrigez manuellement les mappings.`);
        }

        // Scroll to config
        document.getElementById('mapping-config').scrollIntoView({ behavior: 'smooth' });
    }

    function setSelectValue(selectId, value) {
        const select = document.getElementById(selectId);
        if (!select) return;

        // Find option with text matching value (fuzzy match?)
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].text === value) {
                select.selectedIndex = i;
                return;
            }
        }
    }

    function onDatasetChange() {
        const datasetId = document.getElementById('mapping-dataset').value;
        if (!datasetId) return;

        LoadingOverlay.show('Chargement des informations du dataset...');

        fetch('/calculator/api/get-dataset-info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dataset_id: datasetId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    datasetCategories = data.categories || [];
                    datasetElements = data.data_elements || [];
                    document.getElementById('dataset-period-type').textContent = data.period_type || 'N/A';
                    document.getElementById('dataset-categories').textContent =
                        datasetCategories.map(c => c.name).join(', ') || 'Aucune';
                    document.getElementById('dataset-info').classList.remove('hidden');

                    if (excelColumns.length > 0) {
                        buildMappingInterface();
                    }
                }
            })
            .catch(error => NotificationManager.error('Erreur lors du chargement des informations'))
            .finally(() => LoadingOverlay.hide());
    }

    function loadExcelColumns() {
        LoadingOverlay.show('Lecture des colonnes Excel...');

        // Get selected sheet from mapping mode
        const sheetSelector = document.getElementById('mapping-select-sheet');
        const sheetName = sheetSelector ? sheetSelector.value : null;

        console.log(`[loadExcelColumns] Sheet sélectionné: ${sheetName}`);

        // Build URL with sheet parameter
        let url = '/calculator/api/get-columns';
        if (sheetName) {
            url += `?sheet_name=${encodeURIComponent(sheetName)}`;
            console.log(`[loadExcelColumns] URL avec sheet: ${url}`);
        } else {
            console.log(`[loadExcelColumns] Aucun sheet spécifié, utilise le premier par défaut`);
        }

        fetch(url, {
            method: 'GET'
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    excelColumns = data.columns;
                    NotificationManager.success(`${excelColumns.length} colonnes détectées`);

                    const datasetId = document.getElementById('mapping-dataset').value;
                    if (datasetId) {
                        buildMappingInterface();
                    } else {
                        NotificationManager.info('Veuillez sélectionner un dataset');
                    }
                }
            })
            .catch(error => NotificationManager.error('Erreur lors de la lecture des colonnes'))
            .finally(() => LoadingOverlay.hide());
    }

    function buildMappingInterface() {
        // Populate organisation mapping (Column Mode)
        populateSelect('map-org', excelColumns);

        // Build category mappings
        const categoryMappingsDiv = document.getElementById('category-mappings');
        categoryMappingsDiv.innerHTML = '';

        // Add category mappings if any
        datasetCategories.forEach((cat, index) => {
            const mappingRow = document.createElement('div');
            mappingRow.className = 'mapping-row';
            mappingRow.innerHTML = `
                <div class="mapping-label">
                    <i class="fas fa-tag text-orange-600 mr-2"></i>
                    ${cat.name}
                    <span class="text-red-500">*</span>
                </div>
                <div class="mapping-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <div class="mapping-select">
                    <select id="map-cat-${cat.id}" class="form-input category-mapping" data-cat-id="${cat.id}">
                        <option value="">-- Sélectionnez une colonne --</option>
                    </select>
                </div>
            `;
            categoryMappingsDiv.appendChild(mappingRow);
            populateSelect(`map-cat-${cat.id}`, excelColumns);
        });

        // Add data element mappings
        const dataElementsDiv = document.createElement('div');

        // Filter Header
        const filterHeader = document.createElement('div');
        filterHeader.className = 'flex items-center justify-between mt-6 mb-4';
        filterHeader.innerHTML = `
            <h3 class="text-lg font-bold text-gray-900 flex items-center">
                <i class="fas fa-list mr-2 text-blue-600"></i>
                Mappez les data elements
            </h3>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Filtrer par groupe:</label>
                <select id="de-group-filter" class="form-select text-sm rounded-md border-gray-300" onchange="filterDataElements()">
                    <option value="">Tous les groupes</option>
                </select>
            </div>
        `;
        dataElementsDiv.appendChild(filterHeader);

        // DE List Container
        const deListContainer = document.createElement('div');
        deListContainer.id = 'de-list-container';
        dataElementsDiv.appendChild(deListContainer);

        categoryMappingsDiv.appendChild(dataElementsDiv);

        // Populate DE Group Filter
        const groupFilter = document.getElementById('de-group-filter');
        metadataFilters.data_element_groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.name;
            groupFilter.appendChild(opt);
        });

        // Build DE Rows
        datasetElements.forEach((de, index) => {
            const mappingRow = document.createElement('div');
            mappingRow.className = 'mapping-row de-row';
            // Store groups as data attribute for filtering
            const groups = de.groups ? de.groups.map(g => g.id).join(',') : '';
            mappingRow.dataset.groups = groups;

            mappingRow.innerHTML = `
                <div class="mapping-label" title="${de.name}">
                    <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                    <span class="truncate block">${de.name}</span>
                </div>
                <div class="mapping-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <div class="mapping-select">
                    <select id="map-de-${de.id}" class="form-input de-mapping" data-de-id="${de.id}">
                        <option value="">-- Optionnel --</option>
                    </select>
                </div>
            `;
            deListContainer.appendChild(mappingRow);
            populateSelect(`map-de-${de.id}`, excelColumns);
        });

        document.getElementById('mapping-config').classList.remove('hidden');
    }

    function filterDataElements() {
        const groupId = document.getElementById('de-group-filter').value;
        const rows = document.querySelectorAll('.de-row');

        rows.forEach(row => {
            if (!groupId) {
                row.classList.remove('hidden');
            } else {
                const groups = row.dataset.groups ? row.dataset.groups.split(',') : [];
                if (groups.includes(groupId)) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            }
        });
    }

    function populateSelect(selectId, columns) {
        const select = document.getElementById(selectId);
        // Clear existing options except first
        while (select.options.length > 1) {
            select.remove(1);
        }

        columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            select.appendChild(option);
        });
    }

    function processFile() {
        const mode = document.querySelector('input[name="processing-mode"]:checked').value;

        if (mode === 'template') {
            processTemplate();
        } else {
            processMapping();
        }
    }

    function processTemplate() {
        LoadingOverlay.show('Traitement du fichier Excel en cours...');

        // Récupérer les paramètres
        const sheetName = document.getElementById('select-sheet')?.value || 'Données';
        const mode = document.querySelector('input[name="data-type"]:checked')?.value || 'normal';

        const payload = {
            sheet_name: sheetName,
            mode: mode
        };

        // Mode pivot/TCD
        if (mode === 'pivot') {
            // Période (requise)
            const period = document.getElementById('pivot-period')?.value?.trim();
            if (!period) {
                LoadingOverlay.hide();
                NotificationManager.error('Veuillez entrer une période pour le mode tableau croisé');
                return;
            }
            payload.period = period;

            // Data Element (optionnel - auto-détection si vide)
            const deId = document.getElementById('pivot-data-element')?.value;
            if (deId) {
                payload.data_element_id = deId;
            }
            // Si vide, les DE seront auto-détectés depuis la première colonne
        }

        fetch('/calculator/api/process-template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => handleProcessResult(data))
            .catch(error => NotificationManager.error('Erreur lors du traitement'))
            .finally(() => LoadingOverlay.hide());
    }

    function processMapping() {
        const datasetId = document.getElementById('mapping-dataset').value;
        const period = document.getElementById('mapping-period').value;
        const processingMode = document.querySelector('input[name="processing-mode-mapping"]:checked').value;

        // Org Unit Logic
        const orgMode = document.querySelector('input[name="org-mode"]:checked').value;
        let orgColumn = null;
        let fixedOrgUnit = null;

        if (orgMode === 'column') {
            orgColumn = document.getElementById('map-org').value;
            if (!orgColumn) {
                NotificationManager.error('Veuillez sélectionner une colonne pour l\'organisation');
                return;
            }
        } else {
            fixedOrgUnit = document.getElementById('map-org-fixed').value;
            if (!fixedOrgUnit) {
                NotificationManager.error('Veuillez sélectionner une organisation fixe');
                return;
            }
        }

        if (!period) {
            NotificationManager.error('Veuillez saisir une période');
            return;
        }

        // Collect mappings
        const categoryMapping = {};
        document.querySelectorAll('.category-mapping').forEach(select => {
            if (select.value) {
                categoryMapping[select.dataset.catId] = select.value;
            }
        });

        const dataElementMapping = {};
        document.querySelectorAll('.de-mapping').forEach(select => {
            if (select.value) {
                dataElementMapping[select.dataset.deId] = select.value;
            }
        });

        LoadingOverlay.show('Traitement du mapping en cours...');

        fetch('/calculator/api/process-custom', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                dataset_id: datasetId,
                period: period,
                org_column: orgColumn,
                org_mode: orgMode,
                fixed_org_unit: fixedOrgUnit,
                category_mapping: categoryMapping,
                data_element_mapping: dataElementMapping,
                processing_mode: processingMode
            })
        })
            .then(r => r.json())
            .then(data => handleProcessResult(data))
            .catch(error => NotificationManager.error('Erreur lors du traitement'))
            .finally(() => LoadingOverlay.hide());
    }

    function handleProcessResult(data) {
        if (data.success) {
            // Update stats
            document.getElementById('stat-total').textContent = data.total_values;
            document.getElementById('stat-valid').textContent = data.stats.valid;
            document.getElementById('stat-errors').textContent = data.stats.errors;

            const errorRate = data.total_values > 0
                ? Math.round((data.stats.errors / data.total_values) * 100)
                : 0;
            document.getElementById('stat-error-rate').textContent = errorRate + '%';

            // Show errors if any
            const errorDetails = document.getElementById('error-details');
            const errorList = document.getElementById('error-list');
            errorList.innerHTML = '';

            if (data.stats.errors > 0 && data.stats.error_details) {
                data.stats.error_details.slice(0, 10).forEach(err => {
                    const div = document.createElement('div');
                    div.className = 'text-sm text-red-700 mb-1';
                    div.textContent = `Ligne ${err.row}: ${err.message}`;
                    errorList.appendChild(div);
                });
                if (data.stats.error_details.length > 10) {
                    const more = document.createElement('div');
                    more.className = 'text-sm font-bold mt-2';
                    more.textContent = `... et ${data.stats.error_details.length - 10} autres erreurs`;
                    errorList.appendChild(more);
                }
                errorDetails.classList.remove('hidden');
            } else {
                errorDetails.classList.add('hidden');
            }

            // Show preview
            const tbody = document.getElementById('preview-tbody');
            tbody.innerHTML = '';
            data.preview.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2 border-b">${row.dataElement}</td>
                    <td class="px-4 py-2 border-b">${row.period}</td>
                    <td class="px-4 py-2 border-b">${row.orgUnit}</td>
                    <td class="px-4 py-2 border-b font-mono">${row.value}</td>
                `;
                tbody.appendChild(tr);
            });

            // Show results section
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('download-section').classList.remove('hidden');

            // Update JSON info
            document.getElementById('json-info').textContent =
                `Fichier: ${data.json_filename} (${data.total_values} valeurs)`;

            setStep(2, 'completed');
            setStep(3, 'active');

            // Scroll to results
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        } else {
            NotificationManager.error(data.error || 'Erreur inconnue');
            if (data.details) {
                displayValidationErrors(data.details);
            }
        }
    }

    function previewJson() {
        LoadingOverlay.show('Chargement de l\'aperçu...');
        fetch('/calculator/api/preview-json')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('json-preview-container');
                const content = document.getElementById('json-content');
                content.textContent = JSON.stringify(data, null, 2);
                container.classList.remove('hidden');
                container.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(e => NotificationManager.error('Erreur lors de l\'aperçu'))
            .finally(() => LoadingOverlay.hide());
    }

    function closeJsonPreview() {
        document.getElementById('json-preview-container').classList.add('hidden');
    }

    function downloadJson() {
        window.location.href = '/calculator/api/download-json';
    }

    function sendToDhis2() {
        NotificationManager.warning('Envoi vers DHIS2 en cours...', 'Confirmation');

        setTimeout(() => {
            LoadingOverlay.show('Envoi vers DHIS2 en cours...');

            fetch('/calculator/api/send-to-dhis2', {
                method: 'POST'
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        NotificationManager.success(data.message);
                        // Show details if available
                        if (data.details && data.details.importCount) {
                            const counts = data.details.importCount;
                            NotificationManager.info(
                                `Importés: ${counts.imported} | Mis à jour: ${counts.updated} | Ignorés: ${counts.ignored} | Supprimés: ${counts.deleted}`,
                                'Détails de l\'import'
                            );
                        }
                    } else {
                        NotificationManager.error(data.error || 'Erreur lors de l\'envoi');
                    }
                })
                .catch(e => NotificationManager.error('Erreur réseau'))
                .finally(() => LoadingOverlay.hide());
        }, 100);
    }

    // Load Excel sheets
    async function loadExcelSheets() {
        try {
            const response = await fetch("{{ url_for('calculator.get_excel_sheets') }}");
            const data = await response.json();

            if (data.success && data.sheets && data.sheets.length > 0) {
                const select = document.getElementById('select-sheet');
                select.innerHTML = '';

                // Populate sheets
                data.sheets.forEach(sheet => {
                    const option = document.createElement('option');
                    option.value = sheet;
                    option.textContent = sheet;
                    select.appendChild(option);
                });

                // Show sheet selector if multiple sheets
                if (data.count > 1) {
                    document.getElementById('sheet-selection').classList.remove('hidden');
                    document.getElementById('sheet-count').textContent = `${data.count} onglets`;
                } else {
                    document.getElementById('sheet-selection').classList.add('hidden');
                }

                console.log(`Onglets chargés: ${data.sheets.join(', ')}`);
            }
        } catch (error) {
            console.error('Erreur chargement onglets:', error);
        }
    }

    // Load sheets for mapping mode
    async function loadMappingSheets() {
        try {
            const response = await fetch("{{ url_for('calculator.get_excel_sheets') }}");
            const data = await response.json();

            if (data.success && data.sheets && data.sheets.length > 0) {
                const select = document.getElementById('mapping-select-sheet');
                select.innerHTML = '';

                // Populate sheets
                data.sheets.forEach(sheet => {
                    const option = document.createElement('option');
                    option.value = sheet;
                    option.textContent = sheet;
                    select.appendChild(option);
                });

                // Auto-reload columns when sheet changes
                select.addEventListener('change', function () {
                    loadExcelColumns();
                });

                console.log(`[Mapping] Onglets chargés: ${data.sheets.join(', ')}`);

                // Charger les colonnes du premier onglet par défaut
                loadExcelColumns();
            }
        } catch (error) {
            console.error('Erreur chargement onglets mapping:', error);
        }
    }

    // Load data elements for pivot mode
    async function loadDataElements() {
        try {
            // Get data elements from the calculator API
            const response = await fetch("{{ url_for('calculator.get_dhis2_data_elements') }}");
            const data = await response.json();

            if (data.success && data.data_elements) {
                const select = document.getElementById('pivot-data-element');
                select.innerHTML = '<option value="">-- Sélectionnez un Data Element --</option>';

                data.data_elements.forEach(de => {
                    const option = document.createElement('option');
                    option.value = de.id;
                    option.textContent = de.name;
                    select.appendChild(option);
                });

                console.log(`${data.count} data elements chargés`);
            }
        } catch (error) {
            console.error('Erreur chargement data elements:', error);
        }
    }

    function setStep(step, status) {
        const el = document.getElementById(`step-${step}`);
        if (status === 'active') {
            el.classList.add('active');
            el.classList.remove('completed');
        } else if (status === 'completed') {
            el.classList.add('completed');
            el.classList.remove('active');
        } else {
            el.classList.remove('active', 'completed');
        }
    }

    function displayValidationErrors(errors) {
        // Implementation depends on how errors are formatted
        console.error(errors);
        NotificationManager.error('Erreurs de validation détectées. Consultez la console pour plus de détails.');
    }

    // ========== PIVOTED FORMAT FUNCTIONS ==========
    let pivotedData = null;
    let dhis2DataElements = [];

    // Load DHIS2 DE list for dropdowns
    fetch('/calculator/api/get-dhis2-data-elements')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                dhis2DataElements = data.data_elements;
                console.log(`Loaded ${dhis2DataElements.length} DHIS2 data elements for pivoted mapping`);
            }
        })
        .catch(err => console.error('Error loading DHIS2 DE:', err));

    function showPivotedMappingInterface(data) {
        pivotedData = data;

        // Hide normal mapping, show pivoted
        document.getElementById('mapping-config').classList.add('hidden');
        document.getElementById('pivoted-mapping').classList.remove('hidden');

        // Update statistics
        document.getElementById('pivot-stat-total').textContent = data.statistics.total_data_elements;
        document.getElementById('pivot-stat-matched').textContent = data.statistics.matched_with_dhis2;
        document.getElementById('pivot-stat-unmatched').textContent = data.statistics.unmatched;
        document.getElementById('pivot-stat-sections').textContent = data.statistics.total_sections;

        // Build sections view
        const container = document.getElementById('pivoted-sections-container');
        container.innerHTML = '';

        for (const [sectionName, dataElements] of Object.entries(data.sections_mapping)) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-8';

            const matchedCount = dataElements.filter(de => de.dhis2_matched).length;

            sectionDiv.innerHTML = `
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-folder-open text-purple-600"></i>
                    ${sectionName}
                    <span class="text-sm font-normal text-gray-500">(${dataElements.length} éléments, ${matchedCount} auto-matchés)</span>
                </h3>
                <div class="space-y-3">
                    ${dataElements.map((de, idx) => {
                const isMatched = de.dhis2_matched;
                const uniqueId = `pivot-${sectionName.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                return `
                        <div class="flex items-center gap-4 p-4 ${isMatched ? 'bg-green-50 border-2 border-green-200' : 'bg-gray-50'} rounded-lg">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">${de.name}</div>
                                <div class="text-sm text-gray-500">Colonne: ${de.column}</div>
                            </div>
                            <div class="flex-1">
                                ${isMatched ? `
                                    <div class="p-3 bg-white rounded border-2 border-green-500">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-check-circle text-green-600"></i>
                                            <span class="font-semibold text-green-800">${de.dhis2_name}</span>
                                        </div>
                                        <input type="hidden" 
                                               id="${uniqueId}"
                                               data-de-name="${de.name}" 
                                               data-column="${de.column}" 
                                               data-section="${sectionName}"
                                               value="${de.dhis2_id}">
                                    </div>
                                ` : `
                                    <select class="form-select w-full border-orange-500" 
                                            id="${uniqueId}"
                                            data-de-name="${de.name}" 
                                            data-column="${de.column}" 
                                            data-section="${sectionName}">
                                        <option value="">-- Sélectionner un Data Element DHIS2 --</option>
                                        ${dhis2DataElements.map(dhis2De => `
                                            <option value="${dhis2De.id}" 
                                                    data-name="${dhis2De.name}">
                                                ${dhis2De.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                `}
                            </div>
                            <div class="w-24 text-center">
                                ${isMatched ?
                        '<span class="px-3 py-1 text-xs font-bold rounded-full bg-green-600 text-white">AUTO</span>' :
                        '<span class="px-3 py-1 text-xs font-bold rounded-full bg-orange-500 text-white">MANUEL</span>'
                    }
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;

            container.appendChild(sectionDiv);
        }

        // Attach validate button handler
        document.getElementById('btn-validate-pivoted').onclick = validatePivotedMapping;
    }

    function autoMatchPivoted() {
        if (!pivotedData || !dhis2DataElements.length) {
            NotificationManager.error('Données non chargées');
            return;
        }

        let matchCount = 0;

        // Simple fuzzy matching
        document.querySelectorAll('select[id^="pivot-"]').forEach(select => {
            const deName = select.dataset.deName.toLowerCase().trim();

            // Find best match
            let bestMatch = null;
            let bestScore = 0;

            dhis2DataElements.forEach(dhis2De => {
                const dhis2Name = dhis2De.name.toLowerCase().trim();

                // Exact match
                if (dhis2Name === deName) {
                    bestMatch = dhis2De;
                    bestScore = 100;
                }
                // Contains match
                else if (dhis2Name.includes(deName) || deName.includes(dhis2Name)) {
                    const score = Math.max(deName.length / dhis2Name.length, dhis2Name.length / deName.length) * 80;
                    if (score > bestScore) {
                        bestMatch = dhis2De;
                        bestScore = score;
                    }
                }
            });

            if (bestMatch && bestScore > 60) {
                select.value = bestMatch.id;
                matchCount++;
            }
        });

        NotificationManager.success(`${matchCount} correspondances automatiques trouvées`);
    }

    function validatePivotedMapping() {
        const mapping = [];
        let hasErrors = false;

        // Check all selects (manual mapping) and hidden inputs (auto-matched)
        document.querySelectorAll('[id^="pivot-"]').forEach(input => {
            const value = input.value;

            if (!value) {
                if (input.tagName === 'SELECT') {
                    input.classList.add('border-red-500');
                    hasErrors = true;
                }
            } else {
                if (input.tagName === 'SELECT') {
                    input.classList.remove('border-red-500');
                }

                mapping.push({
                    extracted_de: input.dataset.deName,
                    column: input.dataset.column,
                    section: input.dataset.section,
                    dhis2_de_id: value
                });
            }
        });

        if (hasErrors) {
            NotificationManager.error('Veuillez sélectionner un Data Element DHIS2 pour chaque élément non-matché');
            return;
        }

        console.log('Pivoted mapping validated:', mapping);

        // TODO: Process the pivoted data with mapping
        LoadingOverlay.show('Traitement du format pivoté en cours...');

        // For now, just show success
        setTimeout(() => {
            LoadingOverlay.hide();
            NotificationManager.success(`Mapping validé! ${mapping.length} correspondances établies (${pivotedData.statistics.matched_with_dhis2} auto, ${mapping.length - pivotedData.statistics.matched_with_dhis2} manuels).`);
            // TODO: Call backend to transform and process pivoted data
        }, 1000);
    }

    // ============================================================================
    // TCD MODE FUNCTIONS
    // ============================================================================

    let tcdDropzone = null;
    let tcdAnalysisData = null;
    let tcdMappingConfig = {};

    // Initialize TCD Dropzone
    if (document.getElementById('tcd-dropzone')) {
        tcdDropzone = new Dropzone('#tcd-dropzone', {
            url: "{{ url_for('calculator.upload_excel') }}",
            maxFiles: 1,
            maxFilesize: 50,
            acceptedFiles: '.xlsx,.xls',
            addRemoveLinks: true,
            dictDefaultMessage: '',

            init: function () {
                this.on("success", function (file, response) {
                    if (response.success) {
                        document.getElementById('tcd-filename').textContent = response.filename;
                        document.getElementById('tcd-file-info').classList.remove('hidden');
                        NotificationManager.success('Fichier TCD chargé avec succès');
                    }
                });

                this.on("error", function (file, errorMessage) {
                    const msg = typeof errorMessage === 'object' ? errorMessage.error : errorMessage;
                    NotificationManager.error(msg);
                    this.removeFile(file);
                });
            }
        });
    }

    // Analyze TCD File
    document.getElementById('btn-analyze-tcd')?.addEventListener('click', async function () {
        LoadingOverlay.show('Analyse du fichier TCD en cours...');

        try {
            const response = await fetch('/calculator/api/tcd/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                tcdAnalysisData = data;
                populateTCDSheets(data);
                document.getElementById('tcd-config-section').classList.remove('hidden');
                NotificationManager.success(`${data.sheet_count} onglets détectés`);
            } else {
                NotificationManager.error(data.error || 'Erreur lors de l\'analyse');
            }
        } catch (error) {
            NotificationManager.error('Erreur lors de l\'analyse du fichier');
        } finally {
            LoadingOverlay.hide();
        }
    });

    // Populate TCD Sheets
    function populateTCDSheets(data) {
        const select = document.getElementById('tcd-sheet');
        select.innerHTML = '<option value="">-- Sélectionnez un onglet --</option>';

        data.sheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet;
            option.textContent = sheet;

            const analysis = data.sheets_analysis[sheet];
            if (analysis) {
                option.textContent += ` (${analysis.lignes} lignes)`;
            }

            select.appendChild(option);
        });

        select.addEventListener('change', onTCDSheetChange);
    }

    // On TCD Sheet Change
    function onTCDSheetChange() {
        const sheetName = document.getElementById('tcd-sheet').value;

        if (!sheetName || !tcdAnalysisData) return;

        const analysis = tcdAnalysisData.sheets_analysis[sheetName];

        if (!analysis) return;

        // Show sheet info
        document.getElementById('tcd-sheet-info').textContent =
            `${analysis.lignes} lignes, ${analysis.cols_categories.length} colonnes de catégories`;

        // Populate data element column selector
        const colSelect = document.getElementById('tcd-col-de');
        colSelect.innerHTML = '<option value="">-- Sélectionnez une colonne --</option>';

        analysis.cols_categories.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            colSelect.appendChild(option);
        });
    }

    // TCD Org Mode Switching
    document.querySelectorAll('input[name="tcd-org-mode"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const fixedSection = document.getElementById('tcd-fixed-org-section');
            const orgMappingContainer = document.getElementById('tcd-org-mapping-container');

            if (this.value === 'fixed') {
                fixedSection.classList.remove('hidden');
                orgMappingContainer?.classList.add('hidden');
                loadOrganizationsForTCD();
            } else {
                fixedSection.classList.add('hidden');
                orgMappingContainer?.classList.remove('hidden');
            }
        });
    });

    // Load organizations for TCD fixed mode
    async function loadOrganizationsForTCD() {
        const select = document.getElementById('tcd-fixed-org');

        try {
            const response = await fetch('/calculator/api/get-org-units');
            const data = await response.json();

            if (data.success) {
                select.innerHTML = '<option value="">-- Sélectionnez une organisation --</option>';

                data.org_units.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading organizations:', error);
        }
    }

    // Generate Mapping Suggestions
    document.getElementById('btn-tcd-suggestions')?.addEventListener('click', async function () {
        const sheetName = document.getElementById('tcd-sheet').value;
        const colDE = document.getElementById('tcd-col-de').value;

        if (!sheetName || !colDE) {
            NotificationManager.error('Veuillez sélectionner un onglet et une colonne DE');
            return;
        }

        LoadingOverlay.show('Génération des suggestions...');

        try {
            const response = await fetch('/calculator/api/tcd/mapping-suggestions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sheet_name: sheetName,
                    col_data_element: colDE
                })
            });

            const data = await response.json();

            if (data.success) {
                displayTCDMappingSuggestions(data.suggestions);
                document.getElementById('tcd-mapping-section').classList.remove('hidden');
                NotificationManager.success(
                    `${data.mapped_de}/${data.total_de} Data Elements mappés, ${data.mapped_org}/${data.total_org} Orgs mappées`
                );
            } else {
                NotificationManager.error(data.error || 'Erreur lors de la génération des suggestions');
            }
        } catch (error) {
            NotificationManager.error('Erreur lors de la génération des suggestions');
        } finally {
            LoadingOverlay.hide();
        }
    });

    // Display TCD Mapping Suggestions
    function displayTCDMappingSuggestions(suggestions) {
        const orgMode = document.querySelector('input[name="tcd-org-mode"]:checked').value;

        // Data Elements Mapping
        const deList = document.getElementById('tcd-de-mapping-list');
        deList.innerHTML = '';

        Object.entries(suggestions.data_elements || {}).forEach(([valTCD, info]) => {
            const div = document.createElement('div');
            div.className = 'bg-white border border-gray-200 rounded-lg p-4';

            const confidence = info.confidence === 'high' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';

            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold text-gray-900">${valTCD}</div>
                    <span class="text-xs ${confidence} px-2 py-0.5 rounded-full font-semibold">${info.confidence}</span>
                </div>
                <div class="text-sm text-gray-600">→ ${info.suggested}</div>
                <input type="hidden" class="tcd-de-mapping" data-tcd-value="${valTCD}" value="${info.suggested}">
            `;

            deList.appendChild(div);
        });

        // Organizations Mapping (only if not fixed mode)
        if (orgMode !== 'fixed') {
            const orgList = document.getElementById('tcd-org-mapping-list');
            orgList.innerHTML = '';

            Object.entries(suggestions.etablissements || {}).forEach(([valTCD, info]) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-4';

                const confidence = info.confidence === 'high' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';

                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-bold text-gray-900">${valTCD}</div>
                        <span class="text-xs ${confidence} px-2 py-0.5 rounded-full font-semibold">${info.match_type}: ${info.confidence}</span>
                    </div>
                    <div class="text-sm text-gray-600">→ ${info.suggested}</div>
                    <input type="hidden" class="tcd-org-mapping" data-tcd-value="${valTCD}" value="${info.suggested}">
                `;

                orgList.appendChild(div);
            });
        }
    }

    // Process TCD
    document.getElementById('btn-tcd-process')?.addEventListener('click', async function () {
        const sheetName = document.getElementById('tcd-sheet').value;
        const colDE = document.getElementById('tcd-col-de').value;
        const period = document.getElementById('tcd-period').value;
        const orgMode = document.querySelector('input[name="tcd-org-mode"]:checked').value;
        const fixedOrg = document.getElementById('tcd-fixed-org').value;

        if (!sheetName || !colDE || !period) {
            NotificationManager.error('Veuillez remplir tous les champs requis');
            return;
        }

        if (orgMode === 'fixed' && !fixedOrg) {
            NotificationManager.error('Veuillez sélectionner une organisation fixe');
            return;
        }

        // Build mapping config
        const mappingConfig = {
            data_elements: {},
            etablissements: {}
        };

        // Collect DE mappings
        document.querySelectorAll('.tcd-de-mapping').forEach(input => {
            const tcdValue = input.dataset.tcdValue;
            const dhis2Value = input.value;
            if (!mappingConfig.data_elements[sheetName]) {
                mappingConfig.data_elements[sheetName] = {};
            }
            mappingConfig.data_elements[sheetName][tcdValue] = ['', dhis2Value];  // [section, de_name]
        });

        // Collect Org mappings
        if (orgMode !== 'fixed') {
            document.querySelectorAll('.tcd-org-mapping').forEach(input => {
                const tcdValue = input.dataset.tcdValue;
                const dhis2Value = input.value;
                mappingConfig.etablissements[tcdValue] = dhis2Value;
            });
        }

        LoadingOverlay.show('Traitement du fichier TCD en cours...');

        try {
            const response = await fetch('/calculator/api/tcd/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sheet_name: sheetName,
                    col_data_element: colDE,
                    period: period,
                    org_mode: orgMode,
                    fixed_org_unit: orgMode === 'fixed' ? fixedOrg : null,
                    mapping_config: mappingConfig
                })
            });

            const data = await response.json();

            if (data.success) {
                displayTCDReport(data);
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('download-section').classList.remove('hidden');
                setStep(2, 'completed');
                NotificationManager.success(`${data.total_values} valeurs générées avec succès`);
            } else {
                NotificationManager.error(data.error || 'Erreur lors du traitement');
                if (data.stats) {
                    displayTCDReport(data);
                }
            }
        } catch (error) {
            NotificationManager.error('Erreur lors du traitement du fichier');
        } finally {
            LoadingOverlay.hide();
        }
    });

    // Display TCD Report
    function displayTCDReport(data) {
        const stats = data.stats;

        // Update stats
        document.getElementById('tcd-stat-lignes').textContent = stats.lignes_traitees || 0;
        document.getElementById('tcd-stat-valeurs').textContent = stats.valeurs_inserees || 0;
        document.getElementById('tcd-stat-org-nm').textContent = Object.keys(stats.etablissements_non_mappes || {}).length;
        document.getElementById('tcd-stat-de-nm').textContent = Object.keys(stats.data_elements_non_mappes || {}).length;

        // Show report section
        document.getElementById('tcd-report-section').classList.remove('hidden');

        // Show errors if any
        const hasErrors = Object.keys(stats.etablissements_non_mappes || {}).length > 0 ||
            Object.keys(stats.data_elements_non_mappes || {}).length > 0;

        if (hasErrors) {
            document.getElementById('tcd-errors-container').classList.remove('hidden');

            // Unmapped Orgs
            if (Object.keys(stats.etablissements_non_mappes || {}).length > 0) {
                document.getElementById('tcd-unmapped-orgs').classList.remove('hidden');
                const orgList = document.getElementById('tcd-unmapped-orgs-list');
                orgList.innerHTML = '';

                Object.entries(stats.etablissements_non_mappes).forEach(([org, count]) => {
                    const div = document.createElement('div');
                    div.textContent = `${org}: ${count} étudiants`;
                    orgList.appendChild(div);
                });
            }

            // Unmapped DEs
            if (Object.keys(stats.data_elements_non_mappes || {}).length > 0) {
                document.getElementById('tcd-unmapped-des').classList.remove('hidden');
                const deList = document.getElementById('tcd-unmapped-des-list');
                deList.innerHTML = '';

                Object.entries(stats.data_elements_non_mappes).forEach(([de, count]) => {
                    const div = document.createElement('div');
                    div.textContent = `${de}: ${count} étudiants`;
                    deList.appendChild(div);
                });
            }
        }

        // Update results section stats (reuse existing)
        if (data.total_values) {
            document.getElementById('stat-total').textContent = data.total_values;
            document.getElementById('stat-valid').textContent = stats.valeurs_inserees;
            document.getElementById('stat-errors').textContent = stats.lignes_traitees - stats.valeurs_inserees;

            document.getElementById('json-info').textContent =
                `Fichier: ${data.json_filename} (${data.total_values} valeurs)`;
        }
    }

    // =============================================================================
    // MODE AUTOMATIQUE - JavaScript
    // =============================================================================

    let autoTemplateFile = null;
    let autoTCDAnalysis = null;
    let autoTCDDropzone = null;
    let autoTemplateOrgs = [];
    let autoTCDEtablissements = [];
    let autoTemplateSectionsDE = {};
    let autoTCDValeursDE = [];
    let autoTemplateOrgsCodes = {};  // {nom: code}
    let autoTCDEtabsCodes = {};  // {nom: code}

    // Upload Template
    document.getElementById('auto-template-input')?.addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        // Upload le template au serveur
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/calculator/api/upload-template', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                autoTemplateFile = result.filepath;
                autoTemplateOrgs = result.organisations_uniques || [];
                autoTemplateOrgsCodes = result.organisations_avec_codes || {};
                autoTemplateSectionsDE = result.sections_de || {};

                // Afficher les infos du template
                document.getElementById('auto-template-info').classList.remove('hidden');
                document.getElementById('auto-template-filename').textContent = file.name;
                document.getElementById('auto-template-rows').textContent = result.rows || '...';
                document.getElementById('auto-template-orgs').textContent = result.orgs || '...';

                // Afficher étape 2
                document.getElementById('auto-step2').classList.remove('hidden');

                // Initialiser le Dropzone TCD
                initializeAutoTCDDropzone();

                NotificationManager.success('Template chargé avec succès');
            } else {
                NotificationManager.error(result.error || 'Erreur lors du chargement du template');
            }
        } catch (error) {
            console.error('Erreur upload template:', error);
            NotificationManager.error('Erreur lors du chargement du template');
        }
    });

    // Initialiser Dropzone TCD
    function initializeAutoTCDDropzone() {
        if (autoTCDDropzone) {
            autoTCDDropzone.destroy();
        }

        Dropzone.autoDiscover = false;

        autoTCDDropzone = new Dropzone("#auto-tcd-dropzone", {
            url: "{{ url_for('calculator.upload_excel') }}",
            maxFiles: 1,
            maxFilesize: 50,
            acceptedFiles: '.xlsx,.xls',
            addRemoveLinks: true,
            dictDefaultMessage: '',
            init: function () {
                this.on("success", async function (file, response) {
                    console.log('[Auto] TCD uploadé:', response);

                    // Analyser le TCD
                    try {
                        const analyzeResponse = await fetch('/calculator/api/auto/analyze-tcd', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const data = await analyzeResponse.json();

                        if (data.success) {
                            autoTCDAnalysis = data;
                            autoTCDEtablissements = data.etablissements_uniques || [];
                            autoTCDEtabsCodes = data.etablissements_avec_codes || {};
                            autoTCDValeursDE = data.valeurs_de_uniques || [];

                            // Afficher info fichier
                            document.getElementById('auto-tcd-info').classList.remove('hidden');
                            document.getElementById('auto-tcd-filename').textContent = response.filename;
                            document.getElementById('auto-tcd-sheets').textContent = data.sheet_count;

                            // Remplir le select des onglets
                            const sheetSelect = document.getElementById('auto-sheet-select');
                            sheetSelect.innerHTML = '<option value="">-- Sélectionnez un onglet --</option>';
                            data.sheets.forEach(sheet => {
                                const option = document.createElement('option');
                                option.value = sheet.name;
                                option.textContent = `${sheet.name} (${sheet.rows} lignes)`;
                                sheetSelect.appendChild(option);
                            });

                            // Afficher étape 3
                            document.getElementById('auto-step3').classList.remove('hidden');

                            NotificationManager.success(`TCD analysé: ${data.sheet_count} onglets trouvés`);
                        } else {
                            NotificationManager.error('Erreur analyse TCD: ' + data.error);
                        }
                    } catch (error) {
                        console.error('[Auto] Erreur analyse:', error);
                        NotificationManager.error('Erreur lors de l\'analyse du TCD');
                    }
                });

                this.on("error", function (file, message) {
                    console.error('[Auto] Erreur upload TCD:', message);
                    NotificationManager.error('Erreur upload: ' + (message.error || message));
                });
            }
        });
    }

    // Changement d'onglet
    document.getElementById('auto-sheet-select')?.addEventListener('change', function () {
        const sheetName = this.value;
        if (!sheetName || !autoTCDAnalysis) return;

        const sheet = autoTCDAnalysis.sheets.find(s => s.name === sheetName);
        if (!sheet) return;

        // Afficher info onglet
        document.getElementById('auto-sheet-info').textContent =
            `${sheet.rows} lignes détectées`;

        // Helper to create options
        const createOptions = (selectedVal = '') => {
            let opts = '<option value="">-- Sélectionner --</option>';
            sheet.columns.forEach(col => {
                const selected = col === selectedVal ? 'selected' : '';
                opts += `<option value="${col}" ${selected}>${col}</option>`;
            });
            return opts;
        };

        // Remplir select colonnes data element
        const colSelect = document.getElementById('auto-col-de');
        colSelect.innerHTML = '<option value="">-- Sélectionnez la colonne --</option>';
        sheet.columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            colSelect.appendChild(option);
        });

        // Remplir select colonne code établissement
        const colCodeSelect = document.getElementById('auto-col-code-etab');
        colCodeSelect.innerHTML = '<option value="">-- Aucun (pas de mapping auto) --</option>';
        sheet.columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            // Auto-sélectionner si c'est une colonne qui ressemble à un code
            if (col.toLowerCase().includes('code') && col.toLowerCase().includes('et')) {
                option.selected = true;
            }
            colCodeSelect.appendChild(option);
        });

        // --- GESTION DES COLONNES DE CATEGORIES ---
        const catContainer = document.getElementById('auto-cat-cols-container');
        catContainer.innerHTML = ''; // Start fresh

        // Fonction pour ajouter une colonne
        window.addAutoCategoryColumn = function (selectedValue = '') {
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <select class="form-input auto-cat-col-select flex-1">
                    ${createOptions(selectedValue)}
                </select>
                <button type="button" class="btn btn-sm btn-ghost text-red-500 hover:bg-red-50" onclick="this.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            catContainer.appendChild(div);
        };

        // Essayer de détecter Sexe et Age automatiquement
        let autoAdded = false;
        sheet.columns.forEach(col => {
            const lower = col.toLowerCase();
            if (lower.includes('sex') || lower.includes('genre') || lower.includes('age') || lower.includes('tranche')) {
                window.addAutoCategoryColumn(col);
                autoAdded = true;
            }
        });

        // Si rien détecté, ajouter 2 vides par défaut (cas standard Age+Sexe)
        if (!autoAdded) {
            window.addAutoCategoryColumn();
            window.addAutoCategoryColumn();
        }

        // Cacher l'étape 4 en attendant la sélection de la colonne
        document.getElementById('auto-step4').classList.add('hidden');
    });

    // Add button listener
    document.getElementById('btn-add-cat-col')?.addEventListener('click', () => {
        if (window.addAutoCategoryColumn) window.addAutoCategoryColumn();
    });

    // Changement de colonne data element
    document.getElementById('auto-col-de')?.addEventListener('change', async function () {
        const colName = this.value;
        const sheetName = document.getElementById('auto-sheet-select').value;
        const colCode = document.getElementById('auto-col-code-etab').value;

        if (!colName || !sheetName) return;

        try {
            // Extraire les valeurs uniques de cette colonne
            const response = await fetch('/calculator/api/auto/extract-tcd-values', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sheet_name: sheetName,
                    column_name: colName,
                    column_code: colCode
                })
            });

            const data = await response.json();

            if (data.success) {
                autoTCDValeursDE = data.valeurs || [];
                autoTCDEtablissements = data.etablissements_uniques || [];
                autoTCDEtabsCodes = data.etablissements_avec_codes || {};

                console.log('Établissements TCD:', autoTCDEtablissements.length);
                console.log('Codes TCD:', Object.keys(autoTCDEtabsCodes).length);
                console.log('Codes Template:', Object.keys(autoTemplateOrgsCodes).length);

                // Afficher étape 4
                document.getElementById('auto-step4').classList.remove('hidden');

                // Initialiser les mappings maintenant que nous avons toutes les données
                setTimeout(async () => {
                    // Effacer les conteneurs
                    document.getElementById('auto-org-mappings').innerHTML = '';
                    document.getElementById('auto-de-mappings').innerHTML = '';

                    // Faire le mapping automatique des établissements par code
                    autoMapOrganisationsByCode();

                    // Ajouter un mapping vide pour les autres
                    addAutoOrgMapping();

                    // --- CHARGER SUGGESTIONS INTELLIGENTES ---
                    let suggestions = {};
                    try {
                        LoadingOverlay.show('Recherche de correspondances intelligentes...');
                        const sugResp = await fetch('/calculator/api/tcd/mapping-suggestions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sheet_name: sheetName,
                                col_data_element: colName
                            })
                        });
                        const sugData = await sugResp.json();
                        if (sugData.success && sugData.suggestions && sugData.suggestions.data_elements) {
                            suggestions = sugData.suggestions.data_elements;

                            // Afficher un petit toast récapitulatif
                            const count = Object.keys(suggestions).length;
                            if (count > 0) {
                                NotificationManager.success(`${count} suggestions trouvées automatiquement`);
                            }
                        }
                    } catch (e) {
                        console.warn("Erreur suggestions:", e);
                    } finally {
                        LoadingOverlay.hide();
                    }

                    // Remplir les Data Elements avec suggestions
                    // On itère sur toutes les valeurs uniques trouvées
                    autoTCDValeursDE.forEach(val => {
                        if (suggestions[val]) {
                            // Si suggestion trouvée, on pré-remplit
                            const s = suggestions[val];
                            addAutoDEMapping(val, s.suggested_section, s.suggested_name);
                        } else {
                            // Sinon vide
                            addAutoDEMapping(val);
                        }
                    });

                }, 100);
            } else {
                NotificationManager.error('Erreur extraction valeurs: ' + data.error);
            }
        } catch (error) {
            console.error('Erreur extraction valeurs:', error);
            NotificationManager.error('Erreur lors de l\'extraction des valeurs');
        }
    });

    // Fonction de mapping automatique par code
    function autoMapOrganisationsByCode() {
        // Inverser le dictionnaire template pour chercher par code
        const templateCodeToName = {};
        for (const [nom, code] of Object.entries(autoTemplateOrgsCodes)) {
            templateCodeToName[code] = nom;
        }

        let mappedCount = 0;
        let unmappedTCD = [];

        // Pour chaque établissement TCD
        for (const [nomTCD, codeTCD] of Object.entries(autoTCDEtabsCodes)) {
            // Chercher le matching dans le template par code
            if (codeTCD && templateCodeToName[codeTCD]) {
                // Mapping trouvé automatiquement
                const nomTemplate = templateCodeToName[codeTCD];
                addAutoOrgMapping(nomTCD, nomTemplate);
                mappedCount++;
            } else {
                // Pas de mapping automatique trouvé
                unmappedTCD.push(nomTCD);
            }
        }

        // Afficher un message sur les mappings automatiques
        if (mappedCount > 0) {
            NotificationManager.success(`${mappedCount} établissement(s) mappé(s) automatiquement par code`);
        }

        if (unmappedTCD.length > 0) {
            NotificationManager.warning(`${unmappedTCD.length} établissement(s) nécessitent un mapping manuel`);
        }
    }

    // Ajouter mapping organisation
    function addAutoOrgMapping(acronyme = '', pattern = '') {
        const container = document.getElementById('auto-org-mappings');
        const div = document.createElement('div');
        div.className = 'grid grid-cols-[1fr_1fr_auto] gap-4 items-center';

        // Créer les options pour les selects
        let tcdOptions = '<option value="">-- Établissement TCD --</option>';
        autoTCDEtablissements.forEach(etab => {
            const selected = etab === acronyme ? 'selected' : '';
            tcdOptions += `<option value="${etab}" ${selected}>${etab}</option>`;
        });

        let templateOptions = '<option value="">-- Organisation Template --</option>';
        autoTemplateOrgs.forEach(org => {
            const selected = org === pattern ? 'selected' : '';
            templateOptions += `<option value="${org}" ${selected}>${org}</option>`;
        });

        div.innerHTML = `
            <select class="form-input auto-org-acronyme">${tcdOptions}</select>
            <select class="form-input auto-org-pattern">${templateOptions}</select>
            <button type="button" class="btn btn-sm bg-red-500 text-white hover:bg-red-600" onclick="this.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    // Ajouter mapping data element
    function addAutoDEMapping(valeur = '', section = '', de = '') {
        const container = document.getElementById('auto-de-mappings');
        const div = document.createElement('div');
        div.className = 'grid grid-cols-[1fr_1fr_1fr_auto] gap-4 items-center';

        // Créer les options pour valeur TCD
        let valeurOptions = '<option value="">-- Valeur TCD --</option>';
        autoTCDValeursDE.forEach(val => {
            const selected = val === valeur ? 'selected' : '';
            valeurOptions += `<option value="${val}" ${selected}>${val}</option>`;
        });

        // Créer les options pour sections
        let sectionOptions = '<option value="">-- Section --</option>';
        Object.keys(autoTemplateSectionsDE).forEach(sec => {
            const selected = sec === section ? 'selected' : '';
            sectionOptions += `<option value="${sec}" ${selected}>${sec}</option>`;
        });

        // Créer le select DE (vide au départ, rempli quand section choisie)
        let deOptions = '<option value="">-- Data Element --</option>';
        if (section && autoTemplateSectionsDE[section]) {
            autoTemplateSectionsDE[section].forEach(dataElem => {
                const selected = dataElem === de ? 'selected' : '';
                deOptions += `<option value="${dataElem}" ${selected}>${dataElem}</option>`;
            });
        }

        div.innerHTML = `
            <select class="form-input auto-de-valeur">${valeurOptions}</select>
            <select class="form-input auto-de-section">${sectionOptions}</select>
            <select class="form-input auto-de-name">${deOptions}</select>
            <button type="button" class="btn btn-sm bg-red-500 text-white hover:bg-red-600" onclick="this.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);

        // Ajouter l'événement pour filtrer les DE quand section change
        const sectionSelect = div.querySelector('.auto-de-section');
        const deSelect = div.querySelector('.auto-de-name');

        sectionSelect.addEventListener('change', function () {
            const selectedSection = this.value;
            deSelect.innerHTML = '<option value="">-- Data Element --</option>';

            if (selectedSection && autoTemplateSectionsDE[selectedSection]) {
                autoTemplateSectionsDE[selectedSection].forEach(dataElem => {
                    const option = document.createElement('option');
                    option.value = dataElem;
                    option.textContent = dataElem;
                    deSelect.appendChild(option);
                });
            }
        });
    }

    // Traiter
    async function processAuto() {
        const sheetName = document.getElementById('auto-sheet-select').value;
        const colDE = document.getElementById('auto-col-de').value;
        const period = document.getElementById('auto-period').value;

        if (!autoTemplateFile || !sheetName || !colDE || !period) {
            NotificationManager.error('Veuillez remplir tous les champs requis');
            return;
        }

        // Récupérer les colonnes de catégories
        const category_cols = [];
        document.querySelectorAll('.auto-cat-col-select').forEach(sel => {
            if (sel.value) category_cols.push(sel.value);
        });

        if (category_cols.length === 0) {
            NotificationManager.error('Veuillez sélectionner au moins une colonne de catégorie (ex: Sexe)');
            return;
        }

        // Récupérer les mappings
        const etablissements_patterns = {};
        document.querySelectorAll('#auto-org-mappings > div').forEach(div => {
            const acronyme = div.querySelector('.auto-org-acronyme').value.trim();
            const pattern = div.querySelector('.auto-org-pattern').value.trim();
            if (acronyme && pattern) {
                etablissements_patterns[acronyme] = pattern;
            }
        });

        const data_elements_manuels = {};
        document.querySelectorAll('#auto-de-mappings > div').forEach(div => {
            const valeur = div.querySelector('.auto-de-valeur').value.trim();
            const section = div.querySelector('.auto-de-section').value.trim();
            const deName = div.querySelector('.auto-de-name').value.trim();
            if (valeur && section && deName) {
                data_elements_manuels[valeur] = [section, deName];
            }
        });

        if (Object.keys(etablissements_patterns).length === 0) {
            NotificationManager.error('Veuillez ajouter au moins un mapping établissement');
            return;
        }

        if (Object.keys(data_elements_manuels).length === 0) {
            NotificationManager.error('Veuillez ajouter au moins un mapping data element');
            return;
        }

        LoadingOverlay.show('Traitement en cours...');

        try {
            const response = await fetch('/calculator/api/auto/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tcd_sheet: sheetName,
                    col_data_element: colDE,
                    period: period,
                    period: period,
                    config: {
                        etablissements_patterns: etablissements_patterns,
                        data_elements_manuels: data_elements_manuels,
                        category_cols: category_cols
                    }
                })
            });

            const data = await response.json();

            LoadingOverlay.hide();

            if (data.success) {
                // Afficher le rapport
                displayAutoReport(data);

                // Afficher étape 5
                document.getElementById('auto-step5').classList.remove('hidden');

                // Afficher la section download avec boutons d'action
                document.getElementById('download-section').classList.remove('hidden');
                document.getElementById('json-info').textContent =
                    `Fichier: ${data.json_filename} (${data.total_values} valeurs)`;

                // Scroller vers le rapport
                document.getElementById('auto-step5').scrollIntoView({ behavior: 'smooth' });

                NotificationManager.success(`Traitement terminé: ${data.total_values} valeurs générées`);
            } else {
                NotificationManager.error('Erreur: ' + data.error);
                if (data.stats) {
                    displayAutoReport(data);
                    document.getElementById('auto-step5').classList.remove('hidden');
                }
            }
        } catch (error) {
            LoadingOverlay.hide();
            console.error('[Auto] Erreur traitement:', error);
            NotificationManager.error('Erreur lors du traitement');
        }
    }

    // Afficher rapport
    function displayAutoReport(data) {
        const stats = data.stats;

        // Statistiques
        document.getElementById('auto-stat-lignes').textContent = stats.lignes_traitees || 0;
        document.getElementById('auto-stat-valeurs').textContent = stats.valeurs_inserees || 0;
        document.getElementById('auto-stat-org-nm').textContent = Object.keys(stats.etablissements_non_mappes || {}).length;
        document.getElementById('auto-stat-de-nm').textContent = Object.keys(stats.data_elements_non_mappes || {}).length;

        // Erreurs
        const hasErrors = (stats.etablissements_non_mappes && Object.keys(stats.etablissements_non_mappes).length > 0) ||
            (stats.data_elements_non_mappes && Object.keys(stats.data_elements_non_mappes).length > 0) ||
            (stats.combinaisons_non_trouvees && stats.combinaisons_non_trouvees.length > 0);

        if (hasErrors) {
            document.getElementById('auto-errors-container').classList.remove('hidden');

            // Orgs non mappées
            if (stats.etablissements_non_mappes && Object.keys(stats.etablissements_non_mappes).length > 0) {
                document.getElementById('auto-unmapped-orgs').classList.remove('hidden');
                const list = document.getElementById('auto-unmapped-orgs-list');
                list.innerHTML = '';
                for (const [org, count] of Object.entries(stats.etablissements_non_mappes)) {
                    const p = document.createElement('p');
                    p.textContent = `${org} (${count} valeurs perdues)`;
                    list.appendChild(p);
                }
            }

            // DEs non mappés
            if (stats.data_elements_non_mappes && Object.keys(stats.data_elements_non_mappes).length > 0) {
                document.getElementById('auto-unmapped-des').classList.remove('hidden');
                const list = document.getElementById('auto-unmapped-des-list');
                list.innerHTML = '';
                for (const [de, count] of Object.entries(stats.data_elements_non_mappes)) {
                    const p = document.createElement('p');
                    p.textContent = `${de} (${count} valeurs perdues)`;
                    list.appendChild(p);
                }
            }

            // Combinaisons non trouvées
            if (stats.combinaisons_non_trouvees && stats.combinaisons_non_trouvees.length > 0) {
                document.getElementById('auto-not-found').classList.remove('hidden');
                const list = document.getElementById('auto-not-found-list');
                list.innerHTML = '';
                stats.combinaisons_non_trouvees.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-red-50 p-2 rounded border border-red-100 mb-2 text-xs';

                    if (item.details) {
                        div.innerHTML = `
                            <div class="font-bold text-red-800 mb-1">
                                <i class="fas fa-times-circle mr-1"></i>
                                Combinaison Introuvable (Valeur: ${item.valeur})
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                                <div><span class="font-semibold">Organisation:</span> ${item.details.organisation}</div>
                                <div><span class="font-semibold">Data Element:</span> ${item.details.data_element}</div>
                                <div class="col-span-2 text-red-700 font-bold border-t border-red-200 mt-1 pt-1">
                                    <span class="font-semibold">Problème Catégorie:</span> "${item.details.coc_norm}" n'existe pas pour cet élément.
                                </div>
                            </div>
                        `;
                    } else {
                        // Fallback pour compatibilité
                        div.textContent = `${item.cle} (valeur: ${item.valeur})`;
                    }
                    list.appendChild(div);
                });
            }
        }

        // Preview
        if (data.preview && data.preview.length > 0) {
            const tbody = document.getElementById('auto-preview-tbody');
            tbody.innerHTML = '';
            data.preview.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm">${row.dataElement}</td>
                    <td class="px-4 py-3 text-sm">${row.orgUnit}</td>
                    <td class="px-4 py-3 text-sm">${row.categoryOptionCombo}</td>
                    <td class="px-4 py-3 text-sm">${row.period}</td>
                    <td class="px-4 py-3 text-sm font-bold">${row.value}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
</script>
{% endblock %}