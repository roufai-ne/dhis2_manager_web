{% extends "layout.html" %}

{% block title %}Calculateur - DHIS2 Data Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
<style>
    /* Step Indicator */
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-2xl);
        position: relative;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }

    .step-circle {
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 50%;
        background: var(--gray-200);
        color: var(--gray-500);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
        margin: 0 auto var(--spacing-sm);
        transition: all 0.3s ease;
        border: 3px solid var(--gray-300);
    }

    .step.active .step-circle {
        background: var(--primary-600);
        color: white;
        border-color: var(--primary-700);
        box-shadow: var(--shadow-lg);
    }

    .step.completed .step-circle {
        background: var(--success-600);
        color: white;
        border-color: var(--success-700);
    }

    .step-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-600);
    }

    .step.active .step-label {
        color: var(--primary-600);
    }

    .step.completed .step-label {
        color: var(--success-600);
    }

    /* Dropzone */
    .calc-dropzone {
        border: 3px dashed var(--gray-300);
        border-radius: var(--radius-xl);
        background: white;
        padding: var(--spacing-2xl);
        transition: all 0.3s ease;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .calc-dropzone:hover {
        border-color: var(--primary-600);
        background: var(--primary-50);
        transform: translateY(-2px);
    }

    /* Stats Grid */
    .stat-card {
        background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        color: white;
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        position: relative;
        overflow: hidden;
    }

    .stat-card:nth-child(2) {
        background: linear-gradient(135deg, var(--success-600), var(--success-700));
    }

    .stat-card:nth-child(3) {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .stat-card:nth-child(4) {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
    }

    /* Button Sizes */
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }

    /* Mode Selection */
    .mode-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .mode-card:hover {
        transform: translateY(-4px);
    }

    .mode-card input:checked+.mode-card-inner {
        border-color: var(--primary-600);
        background: var(--primary-50);
        box-shadow: var(--shadow-lg);
    }

    .mode-card-inner {
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        background: white;
        position: relative;
    }

    .mode-check {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: var(--primary-600);
        opacity: 0;
        transform: scale(0.5);
        transition: all 0.3s ease;
    }

    .mode-card input:checked+.mode-card-inner .mode-check {
        opacity: 1;
        transform: scale(1);
    }

    /* Data Type Selection */
    .data-type-card {
        transition: all 0.3s ease;
        position: relative;
    }

    input[name="data-type"]:checked+.data-type-card {
        border-color: var(--primary-600);
        background-color: var(--primary-50);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    input[name="data-type"][value="pivot"]:checked+.data-type-card {
        border-color: #9333ea;
        background-color: #faf5ff;
    }

    .data-type-card::after {
        content: '';
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        background: white;
        transition: all 0.3s ease;
    }

    input[name="data-type"]:checked+.data-type-card::after {
        content: '✓';
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-600);
        border-color: var(--primary-600);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
    }

    input[name="data-type"][value="pivot"]:checked+.data-type-card::after {
        background: #9333ea;
        border-color: #9333ea;
    }

    /* Mapping Interface */
    .mapping-row {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-sm);
        transition: all 0.2s ease;
    }

    .mapping-row:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-sm);
    }

    .mapping-label {
        flex: 1;
        font-weight: 500;
        color: var(--gray-700);
        display: flex;
        align-items: center;
    }

    .mapping-arrow {
        color: var(--gray-400);
    }

    .mapping-select {
        flex: 1;
    }

    .json-preview {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        font-family: monospace;
        max-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-6 py-12 fade-in">

    <!-- Header -->
    <div class="mb-12 text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">
            Calculateur Automatique
        </h1>
        <p class="text-lg text-gray-600">
            Transformez vos fichiers Excel en données importables dans DHIS2
        </p>
    </div>

    <!-- Mode Selection -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 max-w-4xl mx-auto">
        <!-- Template Mode -->
        <div class="mode-card">
            <label class="block h-full">
                <input type="radio" name="processing-mode" id="mode-template" value="template" class="hidden" checked>
                <div class="mode-card-inner h-full">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice text-blue-600 text-2xl"></i>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle text-2xl"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Mode Template</h3>
                    <p class="text-gray-600 text-sm">
                        Utilisez un fichier Excel généré par le générateur de templates.
                        Le format est déjà standardisé et prêt à l'emploi.
                    </p>
                </div>
            </label>
        </div>

        <!-- Automatic Mode -->
        <div class="mode-card">
            <label class="block h-full">
                <input type="radio" name="processing-mode" id="mode-auto" value="auto" class="hidden">
                <div class="mode-card-inner h-full">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-magic text-emerald-600 text-2xl"></i>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle text-2xl"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Mode Automatique <span
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-semibold ml-1">Nouveau</span>
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Traitement intelligent TCD vers template DHIS2.
                        Normalisation automatique, mapping dynamique, gestion des cellules fusionnées.
                    </p>
                </div>
            </label>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step-1">
            <div class="step-circle">1</div>
            <div class="step-label">Upload Excel</div>
        </div>
        <div class="step" id="step-2">
            <div class="step-circle">2</div>
            <div class="step-label">Traitement</div>
        </div>
        <div class="step" id="step-3">
            <div class="step-circle">3</div>
            <div class="step-label">Téléchargement</div>
        </div>
    </div>

    <!-- Upload Section (Template Mode) -->
    <div id="template-upload-section" class="card mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-upload text-white"></i>
            </div>
            Importez votre fichier Excel template
        </h2>

        <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="excel-dropzone">
            <div class="dz-message needsclick text-center">
                <i class="fas fa-file-excel text-6xl text-green-600 mb-4 block"></i>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Glissez-déposez votre fichier Excel ici</h3>
                <p class="text-gray-600 mb-4">ou cliquez pour sélectionner un fichier</p>
                <div class="flex items-center justify-center gap-3">
                    <span class="badge badge-primary">XLSX</span>
                    <span class="badge badge-success">XLS</span>
                    <span class="text-gray-500 text-sm">• Max 50 MB</span>
                </div>
            </div>
        </form>

        <div id="file-info" class="mt-6 hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-lg" id="uploaded-filename"></p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                Fichier chargé avec succès
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sheet Selection (hidden by default) -->
                <div id="sheet-selection" class="hidden mt-4 pt-4 border-t border-green-200">
                    <div class="form-group">
                        <label for="select-sheet" class="form-label flex items-center gap-2">
                            <i class="fas fa-layer-group text-blue-600"></i>
                            <span class="font-bold">Sélectionnez l'onglet à traiter</span>
                            <span id="sheet-count" class="badge badge-info ml-2"></span>
                        </label>
                        <select id="select-sheet" class="form-input">
                            <!-- Options ajoutées dynamiquement -->
                        </select>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Le fichier contient plusieurs onglets. Sélectionnez celui à traiter.
                        </p>
                    </div>
                </div>

                <!-- Data Type Selection -->
                <div id="data-type-selection" class="mt-4 pt-4 border-t border-green-200">
                    <label class="form-label flex items-center gap-2 mb-3">
                        <i class="fas fa-sliders-h text-purple-600"></i>
                        <span class="font-bold">Type de données</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Mode Normal -->
                        <label class="cursor-pointer">
                            <input type="radio" name="data-type" value="normal" class="hidden" checked>
                            <div
                                class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-all data-type-card">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-invoice text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">Données normales</h4>
                                        <p class="text-xs text-gray-600">Template généré</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600">
                                    Fichier Excel généré par le Générateur avec colonnes techniques pré-remplies.
                                </p>
                            </div>
                        </label>

                        <!-- Mode Tableau Croisé -->
                        <label class="cursor-pointer">
                            <input type="radio" name="data-type" value="pivot" class="hidden">
                            <div
                                class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition-all data-type-card">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-table text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">Tableau croisé</h4>
                                        <p class="text-xs text-gray-600">Structures en colonnes</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600">
                                    Tableau avec structures en colonnes et valeurs aux intersections.
                                </p>
                            </div>
                        </label>
                    </div>

                    <!-- Pivot Mode Options (hidden by default) -->
                    <div id="pivot-options" class="hidden mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <div class="flex items-start gap-3 mb-4">
                            <i class="fas fa-magic text-purple-600 mt-1 text-xl"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 mb-1 flex items-center gap-2">
                                    Mode Tableau Croisé Dynamique (TCD)
                                    <span
                                        class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-semibold">Auto-détection
                                        ✨</span>
                                </h4>
                                <p class="text-sm text-gray-700 mb-2">
                                    Les <strong>data elements sont automatiquement détectés</strong> depuis la première
                                    colonne de votre fichier.
                                </p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li><strong>Première colonne</strong> = noms des indicateurs/data elements (détectés
                                        automatiquement)</li>
                                    <li><strong>Autres colonnes</strong> = noms ou codes des organisations</li>
                                    <li><strong>Valeurs</strong> = données numériques aux intersections</li>
                                </ul>
                                <div class="mt-3 bg-white border border-purple-200 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1"><i
                                            class="fas fa-lightbulb text-yellow-500 mr-1"></i><strong>Exemple de format
                                            :</strong></p>
                                    <pre class="text-xs text-gray-700 font-mono">Indicateur          │ USSGB │ USTB │ UMN
────────────────────┼───────┼──────┼─────
Effectif Licence    │  450  │  320 │ 280
Effectif Master     │   85  │   62 │  58
Taux de réussite    │ 85.5  │ 90.2 │ 87.8</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Period Type -->
                        <div class="form-group mb-4">
                            <label for="pivot-period-type" class="form-label required">Type de Période</label>
                            <div class="relative">
                                <select id="pivot-period-type"
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm py-3 px-4 bg-white transition-colors font-medium border"
                                    onchange="updateCalculatorPeriodOptions('pivot-period-type', 'pivot-period')">
                                    <option value="Monthly">Mensuel</option>
                                    <option value="Quarterly">Trimestriel</option>
                                    <option value="SixMonthly">Semestriel</option>
                                    <option value="Yearly" selected>Annuel</option>
                                    <option value="FinancialYear">Année Financière</option>
                                </select>
                                <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-chevron-down text-xs mr-2"></i>
                                </div>
                            </div>
                        </div>

                        <label for="pivot-period" class="form-label required">
                            <i class="fas fa-calendar mr-2"></i>Période
                        </label>
                        <div class="relative">
                            <select id="pivot-period"
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm py-3 px-4 bg-white transition-colors font-medium border">
                                <!-- Populated by JS -->
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <i class="fas fa-chevron-down text-xs mr-2"></i>
                            </div>
                        </div>
                        <!-- Removed help text as dropdown is self-explanatory -->

                        <!-- Data Element (Optional) -->
                        <div class="form-group">
                            <label for="pivot-data-element" class="form-label">
                                <i class="fas fa-chart-bar mr-2"></i>Data Element fixe <span
                                    class="text-gray-500 font-normal">(optionnel)</span>
                            </label>
                            <select id="pivot-data-element" class="form-input">
                                <option value="">-- Auto-détection depuis le fichier --</option>
                                <!-- Options chargées dynamiquement -->
                            </select>
                            <p class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                <strong>Laisser vide</strong> pour détecter automatiquement les data elements depuis la
                                première colonne.<br>
                                Sélectionner un DE uniquement si toutes les lignes utilisent le même indicateur.
                            </p>
                        </div>

                        <!-- Help Section -->
                        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-question-circle text-blue-600 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Besoin d'aide ?</strong> Consultez la
                                    <a href="#" class="underline hover:text-blue-900"
                                        onclick="NotificationManager.info('Documentation TCD multi-DE disponible dans MODE_TCD_MULTI_DE.md', 'Documentation'); return false;">documentation
                                        du mode TCD</a>
                                    pour plus d'exemples.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <div class="mt-6 flex justify-end">
                    <button id="btn-process" class="btn btn-primary btn-lg">
                        <i class="fas fa-cog mr-2"></i>Traiter le fichier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Mode Sections -->
    <div id="auto-sections" class="hidden">

        <!-- Étape 1: Upload Template DHIS2 -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-file-download text-white"></i>
                </div>
                Étape 1: Template DHIS2
            </h2>

            <div class="mb-6">
                <label class="form-label">Sélectionnez votre template DHIS2 généré</label>
                <input type="file" id="auto-template-input" accept=".xlsx,.xls" class="form-input">
                <p class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Le template doit être généré depuis le module "Générateur de Templates"
                </p>
            </div>

            <div id="auto-template-info" class="hidden">
                <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-check-circle text-emerald-600 text-xl mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900 mb-1">Template chargé</h4>
                            <p class="text-sm text-gray-700" id="auto-template-filename"></p>
                            <p class="text-sm text-gray-600 mt-2">
                                <strong>Lignes:</strong> <span id="auto-template-rows"></span> |
                                <strong>Organisations:</strong> <span id="auto-template-orgs"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 2: Upload TCD -->
        <div id="auto-step2" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-table text-white"></i>
                </div>
                Étape 2: Fichier TCD
            </h2>

            <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="auto-tcd-dropzone">
                <div class="dz-message needsclick">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Déposez votre fichier TCD ici</h3>
                    <p class="text-gray-500">ou cliquez pour sélectionner</p>
                    <p class="text-sm text-gray-400 mt-2">Excel (.xlsx, .xls)</p>
                </div>
            </form>

            <div id="auto-tcd-info" class="mt-6 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-file-excel text-blue-600 text-2xl"></i>
                        <div class="flex-1">
                            <p class="font-bold text-gray-900 text-lg" id="auto-tcd-filename"></p>
                            <p class="text-sm text-gray-600 mt-1">
                                <strong>Onglets:</strong> <span id="auto-tcd-sheets"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 3: Configuration -->
        <div id="auto-step3" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-cog text-white"></i>
                </div>
                Étape 3: Configuration
            </h2>

            <!-- Sélection onglet TCD -->
            <div class="form-group mb-6">
                <label for="auto-sheet-select" class="form-label required">
                    <i class="fas fa-layer-group mr-2"></i>Onglet TCD à traiter
                </label>
                <select id="auto-sheet-select" class="form-input">
                    <option value="">-- Sélectionnez un onglet --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2" id="auto-sheet-info"></p>
            </div>

            <!-- Colonne Data Element -->
            <div class="form-group mb-6">
                <label for="auto-col-de" class="form-label required">
                    <i class="fas fa-columns mr-2"></i>Colonne Data Element
                </label>
                <select id="auto-col-de" class="form-input">
                    <option value="">-- Sélectionnez la colonne --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    Colonne contenant les variables (ex: CYCLE, DIPLÔME, NATIONALITÉ)
                </p>
            </div>

            <!-- Colonne Code Établissement -->
            <div class="form-group mb-6">
                <label for="auto-col-code-etab" class="form-label">
                    <i class="fas fa-barcode mr-2"></i>Colonne Code Établissement (optionnel)
                </label>
                <select id="auto-col-code-etab" class="form-input">
                    <option value="">-- Aucun (pas de mapping auto) --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    Colonne contenant les codes pour le mapping automatique (ex: code_ets, CODE_ETAB)
                </p>
            </div>

            <!-- Colonnes Catégories -->
            <div class="form-group mb-6">
                <label class="form-label required">
                    <i class="fas fa-tags mr-2"></i>Colonnes de Catégories (Option Combo)
                </label>
                <div id="auto-cat-cols-container" class="space-y-2 mb-2">
                    <!-- Dynamically filled -->
                </div>
                <button type="button" class="btn btn-sm btn-outline text-blue-600 border-blue-600 hover:bg-blue-50"
                    id="btn-add-cat-col">
                    <i class="fas fa-plus mr-1"></i>Ajouter une colonne
                </button>
                <p class="text-sm text-gray-600 mt-2">
                    Sélectionnez les colonnes constituant la combinaison de catégorie (ex: Sexe, Age).
                </p>
            </div>

            <!-- Période -->
            <div class="form-group mb-6">
                <label for="auto-period-type" class="form-label required">Type de Période</label>
                <div class="relative">
                    <select id="auto-period-type"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm py-3 px-4 bg-white transition-colors font-medium border"
                        onchange="updateCalculatorPeriodOptions('auto-period-type', 'auto-period')">
                        <option value="Monthly">Mensuel</option>
                        <option value="Quarterly">Trimestriel</option>
                        <option value="SixMonthly">Semestriel</option>
                        <option value="Yearly" selected>Annuel</option>
                        <option value="FinancialYear">Année Financière</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fas fa-chevron-down text-xs mr-2"></i>
                    </div>
                </div>
            </div>

            <div class="form-group mb-6">
                <label for="auto-period" class="form-label required">
                    <i class="fas fa-calendar mr-2"></i>Période
                </label>
                <div class="relative">
                    <select id="auto-period"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm py-3 px-4 bg-white transition-colors font-medium border">
                        <!-- Populated by JS -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fas fa-chevron-down text-xs mr-2"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 4: Mappings -->
        <div id="auto-step4" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-link text-white"></i>
                </div>
                Étape 4: Mappings
            </h2>

            <!-- Mapping Établissements -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-building mr-2"></i>Mapping Établissements
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Associez les acronymes du TCD aux noms complets du template
                </p>

                <div id="auto-org-mappings" class="space-y-3">
                    <!-- Dynamiquement rempli -->
                </div>

                <button type="button" onclick="addAutoOrgMapping()" class="btn-secondary mt-4">
                    <i class="fas fa-plus mr-2"></i>Ajouter un mapping
                </button>
            </div>

            <!-- Mapping Data Elements -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-database mr-2"></i>Mapping Data Elements
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Associez les valeurs du TCD aux Data Elements du template (Section + Nom)
                </p>

                <div id="auto-de-mappings" class="space-y-3">
                    <!-- Dynamiquement rempli -->
                </div>

                <button type="button" onclick="addAutoDEMapping()" class="btn-secondary mt-4">
                    <i class="fas fa-plus mr-2"></i>Ajouter un mapping
                </button>
            </div>

            <!-- Bouton Traiter -->
            <div class="flex justify-end mt-8">
                <button type="button" onclick="processAuto()" class="btn-primary">
                    <i class="fas fa-cogs mr-2"></i>Traiter les données
                </button>
            </div>
        </div>

        <!-- Étape 5: Rapport -->
        <div id="auto-step5" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-check-circle text-white"></i>
                </div>
                Rapport de Traitement
            </h2>

            <!-- Statistiques -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2" id="auto-stat-lignes">0</div>
                    <div class="text-sm opacity-90">Lignes traitées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-green-600" id="auto-stat-valeurs">0</div>
                    <div class="text-sm opacity-90">Valeurs insérées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-orange-600" id="auto-stat-org-nm">0</div>
                    <div class="text-sm opacity-90">Orgs non mappées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-red-600" id="auto-stat-de-nm">0</div>
                    <div class="text-sm opacity-90">DEs non mappés</div>
                </div>
            </div>

            <!-- Détails erreurs -->
            <div id="auto-errors-container" class="hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-orange-600"></i>
                    Détails des erreurs
                </h3>

                <div id="auto-unmapped-orgs" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Organisations non mappées :</h4>
                    <div id="auto-unmapped-orgs-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <div id="auto-unmapped-des" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Data Elements non mappés :</h4>
                    <div id="auto-unmapped-des-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <div id="auto-not-found" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Combinaisons non trouvées (premières 10) :</h4>
                    <div id="auto-not-found-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>
            </div>

            <!-- Preview -->
            <div class="mt-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-eye mr-2"></i>Aperçu des données (10 premières)
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Element
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Organisation
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">COC</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Période</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valeur</th>
                            </tr>
                        </thead>
                        <tbody id="auto-preview-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamiquement rempli -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- OLD TCD-TEMP: placeholder (sera supprimé après) -->
    <div id="tcd-sections-temp" class="hidden">
        <!-- Dataset Selection -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-database text-white"></i>
                </div>
                Étape 1: Sélectionnez le dataset
            </h2>

            <div class="form-group">
                <label for="mapping-dataset" class="form-label">
                    <i class="fas fa-table mr-2"></i>Dataset DHIS2
                </label>
                <select id="mapping-dataset" class="form-input">
                    <option value="">-- Sélectionnez un dataset --</option>
                </select>
            </div>

            <div id="dataset-info" class="mt-4 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-bold text-gray-900 mb-2">Informations du dataset</h4>
                    <div class="text-sm text-gray-700">
                        <p><strong>Type de période:</strong> <span id="dataset-period-type"></span></p>
                        <p><strong>Catégories requises:</strong> <span id="dataset-categories"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload for Mapping -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-upload text-white"></i>
                </div>
                Étape 2: Importez votre fichier Excel brut
            </h2>

            <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="mapping-dropzone">
                <div class="dz-message needsclick text-center">
                    <i class="fas fa-file-excel text-6xl text-green-600 mb-4 block"></i>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Glissez-déposez votre fichier Excel brut</h3>
                    <p class="text-gray-600 mb-4">ou cliquez pour sélectionner un fichier</p>
                    <div class="flex items-center justify-center gap-3">
                        <span class="badge badge-primary">XLSX</span>
                        <span class="badge badge-success">XLS</span>
                        <span class="text-gray-500 text-sm">• Max 50 MB</span>
                    </div>
                </div>
            </form>

            <div id="mapping-file-info" class="mt-6 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-lg" id="mapping-filename"></p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                Fichier chargé - Prêt pour le mapping
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sheet Selection for Mapping -->
                <div class="mt-4 form-group">
                    <label for="mapping-select-sheet" class="form-label">
                        <i class="fas fa-layer-group mr-2"></i>Sélectionnez l'onglet à traiter
                    </label>
                    <select id="mapping-select-sheet" class="form-input">
                        <option value="">-- Chargement des onglets... --</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                        Le fichier contient plusieurs onglets. Sélectionnez celui contenant vos données.
                    </p>
                </div>
            </div>
        </div>

        <!-- AI Analysis Button -->
        <div id="ai-analysis-section" class="card mb-8 hidden">
            <div
                class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        Assistant IA
                    </h3>
                    <p class="text-purple-100">Laissez l'IA analyser votre fichier et configurer le mapping
                        automatiquement.</p>
                </div>
                <button id="btn-analyze-ai" class="btn bg-white text-purple-600 hover:bg-purple-50 border-none">
                    <i class="fas fa-sparkles mr-2"></i>Analyser avec IA
                </button>
            </div>
            <div id="ai-result-badge" class="mt-4 hidden">
                <span
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                    <i class="fas fa-check-circle mr-2"></i>
                    Configuration suggérée (Confiance: <span id="ai-confidence"></span>%)
                </span>
                <p class="text-sm text-gray-600 mt-2" id="ai-reasoning"></p>
            </div>
        </div>

        <!-- Column Mapping -->
        <div id="mapping-config" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-arrows-alt-h text-white"></i>
                </div>
                Étape 3: Mappez les colonnes
            </h2>

            <div class="space-y-4">
                <!-- Processing Mode Selection -->
                <div class="form-group">
                    <label class="form-label required">
                        <i class="fas fa-cogs mr-2"></i>Mode de traitement
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label
                            class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 transition">
                            <input type="radio" name="processing-mode-mapping" value="values" class="mr-3" checked>
                            <div>
                                <div class="font-bold text-gray-900">Mode Valeurs</div>
                                <div class="text-sm text-gray-600">Fichier avec valeurs agrégées (colonnes numériques)
                                </div>
                            </div>
                        </label>
                        <label
                            class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-400 transition">
                            <input type="radio" name="processing-mode-mapping" value="count" class="mr-3">
                            <div>
                                <div class="font-bold text-gray-900">Mode Comptage</div>
                                <div class="text-sm text-gray-600">Enregistrements individuels (compte automatiquement)
                                </div>
                            </div>
                        </label>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <strong>Mode Valeurs:</strong> Pour fichiers pré-agrégés (ex: Faculté, Sexe, Effectif=45)<br>
                        <strong>Mode Comptage:</strong> Pour données brutes (ex: 1 ligne = 1 étudiant → compte
                        automatique)
                    </p>
                </div>

                <!-- Period Mapping -->
                <div class="form-group">
                    <label for="mapping-period" class="form-label required">
                        <i class="fas fa-calendar mr-2"></i>Période
                    </label>
                    <input type="text" id="mapping-period" class="form-input" placeholder="Ex: 202401, 2024Q1, 2024">
                    <p class="text-sm text-gray-600 mt-1">
                        Format selon le type de période du dataset
                    </p>
                </div>

                <!-- Organization Mapping -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-hospital text-blue-600"></i>
                        Organisation Unit (UO)
                        <span class="text-red-500">*</span>
                    </h3>

                    <div class="flex gap-4 mb-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="org-mode" value="column" class="form-radio text-blue-600" checked
                                onchange="toggleOrgMode()">
                            <span class="ml-2 text-gray-700">Colonne Excel</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="org-mode" value="fixed" class="form-radio text-blue-600"
                                onchange="toggleOrgMode()">
                            <span class="ml-2 text-gray-700">Valeur Fixe (DHIS2)</span>
                        </label>
                    </div>

                    <!-- Column Mode -->
                    <div id="org-mode-column">
                        <select id="map-org" class="form-input w-full">
                            <option value="">-- Sélectionnez une colonne --</option>
                        </select>
                    </div>

                    <!-- Fixed Mode -->
                    <div id="org-mode-fixed" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filtrer par
                                    Groupe</label>
                                <select id="filter-org-group"
                                    class="form-select text-sm w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                    onchange="updateOrgUnitList()">
                                    <option value="">Tous les groupes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filtrer par
                                    Niveau</label>
                                <select id="filter-org-level"
                                    class="form-select text-sm w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                    onchange="updateOrgUnitList()">
                                    <option value="">Tous les niveaux</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Sélectionner
                                l'Organisation</label>
                            <select id="map-org-fixed"
                                class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <option value="">-- Sélectionnez une organisation --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="org-count-hint"></p>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Category & Data Element Mappings -->
                <div id="category-mappings"></div>

                <!-- Process Button -->
                <div class="mt-8 flex justify-end">
                    <button id="btn-process-mapping" class="btn btn-primary btn-lg">
                        <i class="fas fa-play-circle mr-2"></i>
                        Traiter le fichier avec mapping
                    </button>
                </div>
            </div>
        </div>

        <!-- Pivoted Format Mapping -->
        <div id="pivoted-mapping" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-table text-white"></i>
                </div>
                Format Pivoté Détecté - Mapping des Data Elements
            </h2>

            <!-- Explanation -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-bold text-blue-900 mb-2">Format Pivoté Détecté</h3>
                        <p class="text-sm text-blue-800 mb-2">
                            Les data elements sont contenus dans les <strong>valeurs des colonnes</strong>, pas dans les
                            noms des colonnes.
                        </p>
                        <p class="text-sm text-blue-700">
                            <strong>Exemple:</strong> Dans la colonne "Cycle", les valeurs "1er cycle", "2e cycle", "3e
                            cycle" sont des data elements DHIS2 distincts.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">Total Trouvés</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-total">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">Auto-matchés</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-matched">0</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">À Mapper</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-unmatched">0</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-lg p-4">
                    <h3 class="text-xs font-semibold uppercase tracking-wide mb-1">Sections</h3>
                    <p class="text-3xl font-bold" id="pivot-stat-sections">0</p>
                </div>
            </div>

            <div id="pivoted-sections-container"></div>

            <div class="mt-6 flex justify-between items-center">
                <button onclick="autoMatchPivoted()" class="btn btn-secondary">
                    <i class="fas fa-magic mr-2"></i>
                    Auto-Match (Fuzzy)
                </button>
                <button id="btn-validate-pivoted" class="btn btn-primary btn-lg">
                    <i class="fas fa-check mr-2"></i>
                    Valider et Traiter
                </button>
            </div>
        </div>
    </div>

    <!-- TCD Mode Sections -->
    <div id="tcd-sections" class="hidden">
        <!-- Step 1: File Upload & Analysis -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-upload text-white"></i>
                </div>
                Étape 1: Importez votre fichier TCD
            </h2>

            <form action="{{ url_for('calculator.upload_excel') }}" class="calc-dropzone" id="tcd-dropzone">
                <div class="dz-message needsclick text-center">
                    <i class="fas fa-file-excel text-6xl text-purple-600 mb-4 block"></i>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Glissez-déposez votre fichier TCD</h3>
                    <p class="text-gray-600 mb-4">ou cliquez pour sélectionner un fichier</p>
                    <div class="flex items-center justify-center gap-3">
                        <span class="badge badge-primary">XLSX</span>
                        <span class="badge badge-success">XLS</span>
                        <span class="text-gray-500 text-sm">• Max 50 MB</span>
                    </div>
                </div>
            </form>

            <div id="tcd-file-info" class="mt-6 hidden">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-lg" id="tcd-filename"></p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                Fichier chargé - Prêt pour l'analyse
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Analyze Button -->
                <div class="mt-4 flex justify-end">
                    <button id="btn-analyze-tcd" class="btn btn-primary">
                        <i class="fas fa-search mr-2"></i>Analyser le fichier
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Sheet & Configuration -->
        <div id="tcd-config-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-cog text-white"></i>
                </div>
                Étape 2: Configuration du traitement
            </h2>

            <!-- Sheet Selection -->
            <div class="form-group mb-6">
                <label for="tcd-sheet" class="form-label required">
                    <i class="fas fa-layer-group mr-2"></i>Onglet à traiter
                </label>
                <select id="tcd-sheet" class="form-input">
                    <option value="">-- Sélectionnez un onglet --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2" id="tcd-sheet-info"></p>
            </div>

            <!-- Data Element Column -->
            <div class="form-group mb-6">
                <label for="tcd-col-de" class="form-label required">
                    <i class="fas fa-columns mr-2"></i>Colonne contenant les Data Elements
                </label>
                <select id="tcd-col-de" class="form-input">
                    <option value="">-- Sélectionnez une colonne --</option>
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Cette colonne contient les noms des indicateurs (ex: CYCLE, DIPLOME, etc.)
                </p>
            </div>

            <!-- Period -->
            <div class="form-group mb-6">
                <label for="tcd-period" class="form-label required">
                    <i class="fas fa-calendar mr-2"></i>Période
                </label>
                <input type="text" id="tcd-period" class="form-input" placeholder="Ex: 2024, 202401..." value="2024">
            </div>

            <!-- Organization Mode -->
            <div class="form-group mb-6">
                <label class="form-label required">
                    <i class="fas fa-building mr-2"></i>Mode d'identification des organisations
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="cursor-pointer">
                        <input type="radio" name="tcd-org-mode" value="code" class="hidden" checked>
                        <div class="radio-card">
                            <i class="fas fa-barcode text-2xl mb-2"></i>
                            <div class="font-bold">Par Code</div>
                            <div class="text-xs text-gray-600 mt-1">Utiliser les codes DHIS2</div>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="tcd-org-mode" value="name" class="hidden">
                        <div class="radio-card">
                            <i class="fas fa-tag text-2xl mb-2"></i>
                            <div class="font-bold">Par Nom</div>
                            <div class="text-xs text-gray-600 mt-1">Utiliser les noms DHIS2</div>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="tcd-org-mode" value="fixed" class="hidden">
                        <div class="radio-card">
                            <i class="fas fa-map-pin text-2xl mb-2"></i>
                            <div class="font-bold">Fixe</div>
                            <div class="text-xs text-gray-600 mt-1">Une seule organisation</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Fixed Org Unit (hidden by default) -->
            <div id="tcd-fixed-org-section" class="form-group mb-6 hidden">
                <label for="tcd-fixed-org" class="form-label required">
                    <i class="fas fa-building mr-2"></i>Organisation fixe
                </label>
                <select id="tcd-fixed-org" class="form-input">
                    <option value="">-- Sélectionnez une organisation --</option>
                </select>
            </div>

            <!-- Generate Suggestions Button -->
            <div class="flex justify-end">
                <button id="btn-tcd-suggestions" class="btn btn-primary">
                    <i class="fas fa-magic mr-2"></i>Générer les suggestions de mapping
                </button>
            </div>
        </div>

        <!-- Step 3: Mapping Configuration -->
        <div id="tcd-mapping-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exchange-alt text-white"></i>
                </div>
                Étape 3: Configuration des mappings
            </h2>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-lightbulb text-blue-600 text-xl"></i>
                    <div class="text-sm text-blue-800">
                        <strong>Mapping intelligent :</strong> Les suggestions sont générées automatiquement en
                        analysant
                        vos données et les métadonnées DHIS2. Vous pouvez les modifier si nécessaire.
                    </div>
                </div>
            </div>

            <!-- Data Elements Mapping -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-purple-600"></i>
                    Mapping des Data Elements
                </h3>
                <div id="tcd-de-mapping-list" class="space-y-3">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Organizations Mapping -->
            <div class="mb-8" id="tcd-org-mapping-container">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-building text-purple-600"></i>
                    Mapping des Organisations
                </h3>
                <div id="tcd-org-mapping-list" class="space-y-3">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Preview & Process Button -->
            <div class="flex justify-between items-center">
                <button id="btn-tcd-preview" class="btn btn-secondary">
                    <i class="fas fa-eye mr-2"></i>Prévisualiser
                </button>
                <button id="btn-tcd-process" class="btn btn-primary btn-lg">
                    <i class="fas fa-cog mr-2"></i>Traiter le fichier
                </button>
            </div>
        </div>

        <!-- Step 4: Preview Section -->
        <div id="tcd-preview-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-eye text-white"></i>
                </div>
                Prévisualisation des données
            </h2>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Organisation</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Data Element</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Catégories</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Valeur</th>
                        </tr>
                    </thead>
                    <tbody id="tcd-preview-tbody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-center">
                <button id="btn-tcd-confirm" class="btn btn-success btn-lg">
                    <i class="fas fa-check mr-2"></i>Confirmer et Générer le JSON
                </button>
            </div>
        </div>

        <!-- Step 5: Processing Report -->
        <div id="tcd-report-section" class="card mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-white"></i>
                </div>
                Rapport de traitement
            </h2>

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2" id="tcd-stat-lignes">0</div>
                    <div class="text-sm opacity-90">Lignes traitées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-green-600" id="tcd-stat-valeurs">0</div>
                    <div class="text-sm opacity-90">Valeurs insérées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-orange-600" id="tcd-stat-org-nm">0</div>
                    <div class="text-sm opacity-90">Orgs non mappées</div>
                </div>
                <div class="stat-card">
                    <div class="text-4xl font-extrabold mb-2 text-red-600" id="tcd-stat-de-nm">0</div>
                    <div class="text-sm opacity-90">DEs non mappés</div>
                </div>
            </div>

            <!-- Errors -->
            <div id="tcd-errors-container" class="hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-orange-600"></i>
                    Détails des erreurs
                </h3>

                <!-- Unmapped Orgs -->
                <div id="tcd-unmapped-orgs" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Organisations non mappées :</h4>
                    <div id="tcd-unmapped-orgs-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <!-- Unmapped DEs -->
                <div id="tcd-unmapped-des" class="mb-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Data Elements non mappés :</h4>
                    <div id="tcd-unmapped-des-list" class="text-sm text-gray-700 space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="card mb-8 hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-chart-bar text-white"></i>
            </div>
            Résultats du traitement
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-total">0</div>
                <div class="text-sm opacity-90">Lignes traitées</div>
            </div>
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-valid">0</div>
                <div class="text-sm opacity-90">Valeurs valides</div>
            </div>
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-errors">0</div>
                <div class="text-sm opacity-90">Erreurs</div>
            </div>
            <div class="stat-card">
                <div class="text-4xl font-extrabold mb-2" id="stat-error-rate">0%</div>
                <div class="text-sm opacity-90">Taux d'erreur</div>
            </div>
        </div>

        <div id="error-details" class="mb-6 hidden">
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle text-2xl mr-3"></i>
                <div>
                    <h3 class="font-bold text-lg mb-2">Détails des erreurs</h3>
                    <div id="error-list"></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="font-bold text-gray-900 mb-4 text-lg flex items-center gap-2">
                <i class="fas fa-eye text-blue-600"></i>
                Aperçu des données (10 premières lignes)
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">DataElement</th>
                            <th class="px-4 py-3 text-left font-semibold">Period</th>
                            <th class="px-4 py-3 text-left font-semibold">OrgUnit</th>
                            <th class="px-4 py-3 text-left font-semibold">Value</th>
                        </tr>
                    </thead>
                    <tbody id="preview-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Download Section -->
    <div id="download-section" class="card hidden">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-8 mb-6">
            <h2 class="text-3xl font-bold mb-3 flex items-center gap-3">
                <i class="fas fa-check-circle"></i>
                Payload généré avec succès !
            </h2>
            <p class="text-green-50 mb-6" id="json-info"></p>
            <div class="flex gap-3">
                <button id="btn-preview-json" class="btn bg-white text-green-700 hover:bg-gray-100">
                    <i class="fas fa-eye mr-2"></i>Prévisualiser
                </button>
                <button id="btn-download-json" class="btn bg-white text-green-700 hover:bg-gray-100">
                    <i class="fas fa-download mr-2"></i>Télécharger JSON
                </button>
                <button id="btn-download-csv-names" class="btn bg-white text-green-700 hover:bg-gray-100">
                    <i class="fas fa-file-csv mr-2"></i>Télécharger CSV (noms)
                </button>
                {% if session.get('dhis2_url') %}
                <button id="btn-send-dhis2" class="btn bg-blue-600 text-white hover:bg-blue-700 border-2 border-white">
                    <i class="fas fa-paper-plane mr-2"></i>Envoyer vers DHIS2
                </button>
                {% endif %}
            </div>
        </div>

        <div id="json-preview-container" class="hidden mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-900 text-lg flex items-center gap-2">
                    <i class="fas fa-code text-purple-600"></i>
                    Aperçu du JSON
                </h3>
                <button id="btn-close-preview" class="btn btn-sm bg-gray-500 text-white hover:bg-gray-600">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
            <div class="json-preview">
                <pre id="json-content"></pre>
            </div>
        </div>

        <div class="text-center">
            <button id="btn-new-calculation" class="btn btn-outline">
                <i class="fas fa-redo mr-2"></i>Nouveau calcul
            </button>
        </div>
    </div>

    <!-- Instructions -->
    <div class="card bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-info-circle text-white"></i>
            </div>
            Instructions
        </h3>
        <ul class="space-y-3 text-gray-700">
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-blue-600 text-lg flex-shrink-0"></i>
                <span>Utilisez un fichier Excel généré par le <strong>Générateur de Templates</strong></span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-blue-600 text-lg flex-shrink-0"></i>
                <span>Assurez-vous d'avoir rempli la colonne <code
                        class="bg-white px-2 py-1 rounded font-mono text-sm">VALEUR</code></span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-blue-600 text-lg flex-shrink-0"></i>
                <span>Le fichier JSON généré peut être importé directement dans DHIS2</span>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<!-- Tabulator for data grid -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
    window.CalculatorConfig = {
        uploadUrl: "{{ url_for('calculator.upload_excel') }}",
        getSheetsUrl: "{{ url_for('calculator.get_excel_sheets') }}",
        getDhis2DeUrl: "{{ url_for('calculator.get_dhis2_data_elements') }}",
        urls: {
            preview: "{{ url_for('calculator.preview_json') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/calculator.js') }}?v={{ range(1, 10000) | random }}"></script>
{% endblock %}
